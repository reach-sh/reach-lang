#!/bin/sh

IMG='reachsh/reach-cli:latest'

run () {
  docker run -t --rm "$IMG" "$@"
}

if ! (which make docker docker-compose >/dev/null 2>&1); then
  echo "Reach relies on an installation of make, docker, and docker-compose"
  exit 1
fi

if [ "$(docker image ls -q $IMG)" = '' ]; then
  if ! (docker pull "$IMG" && run update | sed 's/\r//' | sh); then exit 1; fi
fi

run "$@" >/tmp/reach.$$.out
case "$?" in
  # TODO use less fragile workaround for `\r` characters?
  42) sh -ac "$(sed 's/\r//' /tmp/reach.$$.out)" "$0" ;;
   *) cat /tmp/reach.$$.out ;;
esac
