[{"bookPath":"guide","title":"parallelReduce Guide","titleId":"guide-parallelReduce","hasOtp":true,"hasPageHeader":true},"<h1 id=\"guide-parallelReduce\" class=\"refHeader\">parallelReduce Guide<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#guide-parallelReduce\"><span class=\"icon icon-link\"></span></a></h1>\n<p><i id=\"p_0\" class=\"pid\"></i>The purpose of this guide is to bring together all of the information we have about the parallelReduce and to provide additional clarity on how it works and why we use it.<a href=\"#p_0\" class=\"pid\">0</a></p>\n<h2 id=\"description\" class=\"refHeader\">Description<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#description\"><span class=\"icon icon-link\"></span></a></h2>\n<p><i id=\"p_1\" class=\"pid\"></i>There are layers of abstraction to the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> structure that we should understand first.<a href=\"#p_1\" class=\"pid\">1</a></p>\n<p><i id=\"p_2\" class=\"pid\"></i>Generally speaking it is an abbreviation of a <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_while\" title=\"rsh: while\"><span style=\"color: var(--shiki-token-keyword)\">while</span></a></span> loop pattern.<a href=\"#p_2\" class=\"pid\">2</a></p>\n<p>\n  <i id=\"p_3\" class=\"pid\"></i>The variables you set are repeatedly updated uniquely by each one of your participants until the loop condition no longer holds.\n  Values are updated via <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> statements, while <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_continue\" title=\"rsh: continue\"><span style=\"color: var(--shiki-token-keyword)\">continue</span></a></span> is implicit.<a href=\"#p_3\" class=\"pid\">3</a>\n</p>\n<p><i id=\"p_4\" class=\"pid\"></i>If some thing or many things can be done by many different people, you use a <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> to handle the <span class=\"snip\"><a href=\"/rsh/step/#rsh_fork\" title=\"rsh: fork\"><span style=\"color: var(--shiki-color-text)\">fork</span></a></span> and cases.<a href=\"#p_4\" class=\"pid\">4</a></p>\n<p><i id=\"p_5\" class=\"pid\"></i>A <span class=\"snip\"><a href=\"/rsh/step/#rsh_fork\" title=\"rsh: fork\"><span style=\"color: var(--shiki-color-text)\">fork</span></a></span> is a <span class=\"snip\"><a href=\"/rsh/step/#rsh_race\" title=\"rsh: race\"><span style=\"color: var(--shiki-color-text)\">race</span></a></span> between API members where we are unsure who exactly is performing the next consensus operation, this is why they are common with API members â€“ which offer functionality to many different participants.<a href=\"#p_5\" class=\"pid\">5</a></p>\n<p><i id=\"p_6\" class=\"pid\"></i><span class=\"snip\"><a href=\"/rsh/step/#rsh_fork\" title=\"rsh: fork\"><span style=\"color: var(--shiki-color-text)\">fork</span></a></span> ends in the execution of a <span class=\"snip\"><a href=\"/rsh/compute/#rsh_switch\" title=\"rsh: switch\"><span style=\"color: var(--shiki-token-keyword)\">switch</span></a></span> structure, executing the appropriate case (if <code>Bob1</code> wins do this, if <code>Bob2</code> wins do that). Read more about <span class=\"snip\"><a href=\"/rsh/step/#rsh_fork\" title=\"rsh: fork\"><span style=\"color: var(--shiki-color-text)\">fork</span></a></span>, including the underlying code that makes up the <span class=\"snip\"><a href=\"/rsh/step/#rsh_fork\" title=\"rsh: fork\"><span style=\"color: var(--shiki-color-text)\">fork</span></a></span> keyword.<a href=\"#p_6\" class=\"pid\">6</a></p>\n<div class=\"note\">\n  <p><i id=\"p_7\" class=\"pid\"></i>Learn more about <span class=\"snip\"><a href=\"/rsh/step/#rsh_race\" title=\"rsh: race\"><span style=\"color: var(--shiki-color-text)\">race</span></a></span> in the <a href=\"/guide/race/#guide-race\">race guide</a>.<a href=\"#p_7\" class=\"pid\">7</a></p>\n</div>\n<p><i id=\"p_8\" class=\"pid\"></i>Read through the <a href=\"/guide/ctransfers/#guide-ctransfers\">guide about when to use what kind of consensus transfer</a>.<a href=\"#p_8\" class=\"pid\">8</a></p>\n<p><i id=\"p_9\" class=\"pid\"></i>After you understand that you can examine the structure of <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> components and their definitions.<a href=\"#p_9\" class=\"pid\">9</a></p>\n<p><i id=\"p_10\" class=\"pid\"></i>Let's start by looking at the most simple <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> that we could implement.<a href=\"#p_10\" class=\"pid\">10</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/parallelReduce-api_-counter/index.rsh\">/examples/parallelReduce-api_-counter/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const B = API({\n    countUp: Fun([], UInt),\n  });\" href=\"#\" id=\"copyBtn1\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"8\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-function)\">API</span></a><span style=\"color: var(--shiki-color-text)\">({</span></li><li value=\"9\"><span style=\"color: var(--shiki-color-text)\">    countUp</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_Fun\" title=\"rsh: Fun\"><span style=\"color: var(--shiki-token-function)\">Fun</span></a><span style=\"color: var(--shiki-color-text)\">([]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> UInt)</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"10\"><span style=\"color: var(--shiki-color-text)\">  });</span></li></ol></pre>\n<p><i id=\"p_11\" class=\"pid\"></i>Here we declare one API member function <code>countUp</code> for the API on line 9, then define its functionality below.<a href=\"#p_11\" class=\"pid\">11</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/parallelReduce-api_-counter/index.rsh\">/examples/parallelReduce-api_-counter/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const count = parallelReduce(0)\n    .invariant(balance() == 0, &quot;network token balance wrong&quot;)\n    .while(count < max)\n    .api_(B.countUp, () => {\n      return [0, (ret) => {\n        ret(count);\n        return count + 1;\n      }];\n    })\" href=\"#\" id=\"copyBtn2\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"18\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_count\" title=\"rsh: count\"><span style=\"color: var(--shiki-token-constant)\">count</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-token-function)\">parallelReduce</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"network token balance wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"20\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.while\" title=\"rsh: parallelReduce.while\"><span style=\"color: var(--shiki-token-function)\">.while</span></a><span style=\"color: var(--shiki-color-text)\">(count </span><a href=\"/rsh/compute/#rsh_%3C\" title=\"rsh: <\"><span style=\"color: var(--shiki-token-keyword)\">&lt;</span></a><span style=\"color: var(--shiki-color-text)\"> max)</span></li><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.api_\" title=\"rsh: parallelReduce.api_\"><span style=\"color: var(--shiki-token-function)\">.api_</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.countUp</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(count);</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> count </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"26\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_12\" class=\"pid\"></i>Line 18 declares one loop variable <code>count</code> and initializes it to zero, starting the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span>.<a href=\"#p_12\" class=\"pid\">12</a></li>\n  <li><i id=\"p_13\" class=\"pid\"></i>Line 19 sets the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_invariant\" title=\"rsh: invariant\"><span style=\"color: var(--shiki-color-text)\">invariant</span></a></span>, this contract will accept no tokens.<a href=\"#p_13\" class=\"pid\">13</a></li>\n  <li><i id=\"p_14\" class=\"pid\"></i>Line 20 is a standard <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_while\" title=\"rsh: while\"><span style=\"color: var(--shiki-token-keyword)\">while</span></a></span> loop condition, it runs until the condition breaks.<a href=\"#p_14\" class=\"pid\">14</a></li>\n  <li>\n    <i id=\"p_15\" class=\"pid\"></i>Line 21 is the definition of our API member function <code>countUp</code>\n    <code>API.functionName</code> and takes zero arguments.<a href=\"#p_15\" class=\"pid\">15</a>\n  </li>\n  <li><i id=\"p_16\" class=\"pid\"></i>Line 22 starts the outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> and zero is in the pay expression. This function takes no payment from the user. You can specify any number to be paid by the user here. You can also omit the zero and Reach will synthesize this to zero. <code>ret</code> is the <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> function to return the function signature value to the caller. Here we have said that the <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> value is a <span class=\"snip\"><a href=\"/rsh/compute/#rsh_UInt\" title=\"rsh: UInt\"><span style=\"color: var(--shiki-color-text)\">UInt</span></a></span> on line 8. More information on this below.<a href=\"#p_16\" class=\"pid\">16</a></li>\n  <li><i id=\"p_17\" class=\"pid\"></i>Line 23 invokes that <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> function and returns the <code>count</code>.<a href=\"#p_17\" class=\"pid\">17</a></li>\n  <li><i id=\"p_18\" class=\"pid\"></i>Line 24 updates the <code>count</code> loop variable to <code>newCount</code>.<a href=\"#p_18\" class=\"pid\">18</a></li>\n</ul>\n<h3 id=\"api-inputs-and-returns\" class=\"refHeader\">API Inputs and Returns<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#api-inputs-and-returns\"><span class=\"icon icon-link\"></span></a></h3>\n<p><i id=\"p_19\" class=\"pid\"></i>All API member functions must rely only on consensus state and the function inputs.<a href=\"#p_19\" class=\"pid\">19</a></p>\n<p><i id=\"p_20\" class=\"pid\"></i>The API member function has a consensus reduction specification function that takes an argument. Here that function is called <code>ret</code>.<a href=\"#p_20\" class=\"pid\">20</a></p>\n<p><i id=\"p_21\" class=\"pid\"></i>You can name this function anything you like, traditionally <code>ret</code> or <code>k</code> is used to denote return or continuation, respectively.<a href=\"#p_21\" class=\"pid\">21</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/rsvp-6-vevt/index.rsh\">/examples/rsvp-6-vevt/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(Guest.register, () => {\n      check(! done, &quot;event started&quot;);\n      check(isNone(Guests[this]), &quot;already registered&quot;);\n      return [ reservation, (ret) => {\n        enforce( thisConsensusTime() < deadline, &quot;too late&quot; );\n        Guests[this] = true;\n        Notify.register(this);\n        ret(null);\n        return [ false, howMany + 1 ];\n      } ];\n    })\" href=\"#\" id=\"copyBtn3\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"52\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">Guest</span><span style=\"color: var(--shiki-color-text)\">.register</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"53\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_!\" title=\"rsh: !\"><span style=\"color: var(--shiki-token-keyword)\">!</span></a><span style=\"color: var(--shiki-color-text)\"> done</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"event started\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"54\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isNone\" title=\"rsh: isNone\"><span style=\"color: var(--shiki-token-function)\">isNone</span></a><span style=\"color: var(--shiki-color-text)\">(Guests[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"already registered\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"55\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ reservation</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"56\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_enforce\" title=\"rsh: enforce\"><span style=\"color: var(--shiki-token-function)\">enforce</span></a><span style=\"color: var(--shiki-color-text)\">( </span><a href=\"/rsh/compute/#rsh_thisConsensusTime\" title=\"rsh: thisConsensusTime\"><span style=\"color: var(--shiki-token-function)\">thisConsensusTime</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_%3C\" title=\"rsh: <\"><span style=\"color: var(--shiki-token-keyword)\">&lt;</span></a><span style=\"color: var(--shiki-color-text)\"> deadline</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"too late\"</span><span style=\"color: var(--shiki-color-text)\"> );</span></li><li value=\"57\"><span style=\"color: var(--shiki-color-text)\">        Guests[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_true\" title=\"rsh: true\"><span style=\"color: var(--shiki-token-constant)\">true</span></a><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"58\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-constant)\">Notify</span><span style=\"color: var(--shiki-token-function)\">.register</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"59\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"60\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ </span><a href=\"/rsh/compute/#rsh_false\" title=\"rsh: false\"><span style=\"color: var(--shiki-token-constant)\">false</span></a><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> howMany </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\"> ];</span></li><li value=\"61\"><span style=\"color: var(--shiki-color-text)\">      } ];</span></li><li value=\"62\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<p><i id=\"p_22\" class=\"pid\"></i><code>ret</code> must be called inside the API member function to provide the <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> value to the API caller. Below on line 17 is the function signature for the API member function <code>register</code>. It takes no arguments and returns <span class=\"snip\"><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a></span>.<a href=\"#p_22\" class=\"pid\">22</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/rsvp-6-vevt/index.rsh\">/examples/rsvp-6-vevt/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const Guest = API('Guest', {\n    register: Fun([], Null),\n  });\" href=\"#\" id=\"copyBtn4\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"16\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">Guest</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-function)\">API</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">'Guest'</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"17\"><span style=\"color: var(--shiki-color-text)\">    register</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_Fun\" title=\"rsh: Fun\"><span style=\"color: var(--shiki-token-function)\">Fun</span></a><span style=\"color: var(--shiki-color-text)\">([]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> Null)</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"18\"><span style=\"color: var(--shiki-color-text)\">  });</span></li></ol></pre>\n<p><i id=\"p_23\" class=\"pid\"></i>And here again is the implementation of the <code>register</code> function, this time pointing to the inputs and outputs.<a href=\"#p_23\" class=\"pid\">23</a></p>\n<p><i id=\"p_24\" class=\"pid\"></i>Remember, it takes no arguments and returns <span class=\"snip\"><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a></span>.<a href=\"#p_24\" class=\"pid\">24</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/rsvp-6-vevt/index.rsh\">/examples/rsvp-6-vevt/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(Guest.register, () => {\n      check(! done, &quot;event started&quot;);\n      check(isNone(Guests[this]), &quot;already registered&quot;);\n      return [ reservation, (ret) => {\n        enforce( thisConsensusTime() < deadline, &quot;too late&quot; );\n        Guests[this] = true;\n        Notify.register(this);\n        ret(null);\n        return [ false, howMany + 1 ];\n      } ];\n    })\" href=\"#\" id=\"copyBtn5\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"52\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">Guest</span><span style=\"color: var(--shiki-color-text)\">.register</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"53\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_!\" title=\"rsh: !\"><span style=\"color: var(--shiki-token-keyword)\">!</span></a><span style=\"color: var(--shiki-color-text)\"> done</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"event started\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"54\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isNone\" title=\"rsh: isNone\"><span style=\"color: var(--shiki-token-function)\">isNone</span></a><span style=\"color: var(--shiki-color-text)\">(Guests[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"already registered\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"55\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ reservation</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"56\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_enforce\" title=\"rsh: enforce\"><span style=\"color: var(--shiki-token-function)\">enforce</span></a><span style=\"color: var(--shiki-color-text)\">( </span><a href=\"/rsh/compute/#rsh_thisConsensusTime\" title=\"rsh: thisConsensusTime\"><span style=\"color: var(--shiki-token-function)\">thisConsensusTime</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_%3C\" title=\"rsh: <\"><span style=\"color: var(--shiki-token-keyword)\">&lt;</span></a><span style=\"color: var(--shiki-color-text)\"> deadline</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"too late\"</span><span style=\"color: var(--shiki-color-text)\"> );</span></li><li value=\"57\"><span style=\"color: var(--shiki-color-text)\">        Guests[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_true\" title=\"rsh: true\"><span style=\"color: var(--shiki-token-constant)\">true</span></a><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"58\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-constant)\">Notify</span><span style=\"color: var(--shiki-token-function)\">.register</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"59\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"60\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ </span><a href=\"/rsh/compute/#rsh_false\" title=\"rsh: false\"><span style=\"color: var(--shiki-token-constant)\">false</span></a><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> howMany </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\"> ];</span></li><li value=\"61\"><span style=\"color: var(--shiki-color-text)\">      } ];</span></li><li value=\"62\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_25\" class=\"pid\"></i>Line 52 specifies the API and which function we are referencing <code>Guest.register</code>. The empty parenthesis denotes that it takes no parameters.<a href=\"#p_25\" class=\"pid\">25</a></li>\n  <li><i id=\"p_26\" class=\"pid\"></i>Line 59 invokes our <code>ret</code> function and returns a <span class=\"snip\"><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a></span> value to the caller.<a href=\"#p_26\" class=\"pid\">26</a></li>\n</ul>\n<div class=\"q-and-a\" data-bs-toggle=\"collapse\" aria-expanded=\"false\" href=\"#q0\">\n  <p><i id=\"p_27\" class=\"pid\"></i>As an exercise -- bring the <code>index.rsh</code> file to your machine and change the <code>ret(null)</code> on line 59 to <code>ret(true)</code> and see what error comes up.<a href=\"#p_27\" class=\"pid\">27</a></p>\n  <div class=\"collapse\" id=\"q0\">\n    <p><i id=\"p_28\" class=\"pid\"></i>You should get a type mismatch error, because the return does not match the function signature. <a href=\"/rsh/errors/#RE0088\">RE0088</a><a href=\"#p_28\" class=\"pid\">28</a></p>\n  </div>\n</div>\n<p><i id=\"p_29\" class=\"pid\"></i>Now that we understand our loop, how to update values, and how to structure function inputs and outputs -- let's look at the difference in syntax between <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api</span></span> and <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api_</span></span>.<a href=\"#p_29\" class=\"pid\">29</a></p>\n<h3 id=\"api_-vs-api-syntax\" class=\"refHeader\">.api_ vs .api Syntax<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#api_-vs-api-syntax\"><span class=\"icon icon-link\"></span></a></h3>\n<h4 id=\"api_\" class=\"refHeader\">.api_<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#api_\"><span class=\"icon icon-link\"></span></a></h4>\n<p><i id=\"p_30\" class=\"pid\"></i>We will demonstrate our <code>countUp</code> function with both <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api</span></span> and <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api_</span></span>.<a href=\"#p_30\" class=\"pid\">30</a></p>\n<p><i id=\"p_31\" class=\"pid\"></i>In the following examples these two functions have the same funtionality, to increase the count by one each time a user calls our function.<a href=\"#p_31\" class=\"pid\">31</a></p>\n<p><i id=\"p_32\" class=\"pid\"></i>First, the <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api_</span></span> that you have seen already.<a href=\"#p_32\" class=\"pid\">32</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/parallelReduce-api_-counter/index.rsh\">/examples/parallelReduce-api_-counter/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(B.countUp, () => {\n      return [0, (ret) => {\n        ret(count);\n        return count + 1;\n      }];\n    })\" href=\"#\" id=\"copyBtn6\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.countUp</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(count);</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> count </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"26\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_33\" class=\"pid\"></i>Line 21 denotes the start of our API member function <code>B.countUp</code>. The empty parenthesis means it takes no arguments.<a href=\"#p_33\" class=\"pid\">33</a></li>\n  <li><i id=\"p_34\" class=\"pid\"></i>Line 22 starts the outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span>. Zero denotes the amount to be paid and we declare our <code>ret</code> function.<a href=\"#p_34\" class=\"pid\">34</a></li>\n  <li><i id=\"p_35\" class=\"pid\"></i>Line 23 invokes our <code>ret</code> function and returns the value of <code>count</code> to the caller.<a href=\"#p_35\" class=\"pid\">35</a></li>\n  <li><i id=\"p_36\" class=\"pid\"></i>Line 24 updates the loop variable <code>count</code> increasing it by one.<a href=\"#p_36\" class=\"pid\">36</a></li>\n</ul>\n<p><i id=\"p_37\" class=\"pid\"></i>Any checks performed before the <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> statement will be applied in the local step, during payment and the consensus step of the API call. You should use <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api_</span></span> when this check is the same for these steps.<a href=\"#p_37\" class=\"pid\">37</a></p>\n<h4 id=\"api\" class=\"refHeader\">.api<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#api\"><span class=\"icon icon-link\"></span></a></h4>\n<p><i id=\"p_38\" class=\"pid\"></i>Now notice the difference in syntax for <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api</span></span>. Remember, this function does the same thing as the one above.<a href=\"#p_38\" class=\"pid\">38</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/parallelReduce-api-counter/index.rsh\">/examples/parallelReduce-api-counter/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api(B.countUp, \n      () => {},\n      () => 0,\n      (ret) => {\n        ret(count)\n        return count + 1;\n      })\" href=\"#\" id=\"copyBtn7\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.countUp</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">      () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {}</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">      () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">      (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(count)</span></li><li value=\"26\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> count </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"27\"><span style=\"color: var(--shiki-color-text)\">      })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_39\" class=\"pid\"></i>Line 21 denotes the start of our API member function <code>B.countUp</code>.<a href=\"#p_39\" class=\"pid\">39</a></li>\n  <li><i id=\"p_40\" class=\"pid\"></i>Line 22 is for the <code>ASSUME_EXPR</code>. The empty parenthesis means it takes no arguments. These will be evaluated in a local step, so you may use it to add things you <span class=\"snip\"><a href=\"/rsh/local/#rsh_assume\" title=\"rsh: assume\"><span style=\"color: var(--shiki-color-text)\">assume</span></a></span> about the values given by the API caller.<a href=\"#p_40\" class=\"pid\">40</a></li>\n  <li><i id=\"p_41\" class=\"pid\"></i>Line 23 is the pay expression, it is set to zero, matching our previous function.<a href=\"#p_41\" class=\"pid\">41</a></li>\n  <li><i id=\"p_42\" class=\"pid\"></i>Line 24 declares our <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> function <code>ret</code>.<a href=\"#p_42\" class=\"pid\">42</a></li>\n  <li><i id=\"p_43\" class=\"pid\"></i>Line 25 invokes that <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span>, sending <code>count</code> back to the caller.<a href=\"#p_43\" class=\"pid\">43</a></li>\n  <li><i id=\"p_44\" class=\"pid\"></i>Line 26 updates our loop variable <code>count</code>.<a href=\"#p_44\" class=\"pid\">44</a></li>\n</ul>\n<p><i id=\"p_45\" class=\"pid\"></i>A key difference now is the ability to specify different verification checks for the different Reach modes your function will go through.<a href=\"#p_45\" class=\"pid\">45</a></p>\n<p><i id=\"p_46\" class=\"pid\"></i>You could have an <span class=\"snip\"><a href=\"/rsh/local/#rsh_assume\" title=\"rsh: assume\"><span style=\"color: var(--shiki-color-text)\">assume</span></a></span> expression that evaluates in the users local step and a different expression to <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_require\" title=\"rsh: require\"><span style=\"color: var(--shiki-color-text)\">require</span></a></span> in a consensus step.<a href=\"#p_46\" class=\"pid\">46</a></p>\n<p><i id=\"p_47\" class=\"pid\"></i>Read through both of these functions again, this time comparing syntax for the same operation in each function.<a href=\"#p_47\" class=\"pid\">47</a></p>\n<p><i id=\"p_48\" class=\"pid\"></i>You see that <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api_</span></span> is an abstraction of <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api</span></span> with more compact syntax and <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api</span></span> allows you to specify different verification checks at different steps of the function.<a href=\"#p_48\" class=\"pid\">48</a></p>\n<p><i id=\"p_49\" class=\"pid\"></i>Now that we are comfortable with the syntax -- let's look at accessing some values.<a href=\"#p_49\" class=\"pid\">49</a></p>\n<h3 id=\"define-your-views\" class=\"refHeader\">.define your Views<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#define-your-views\"><span class=\"icon icon-link\"></span></a></h3>\n<p><i id=\"p_50\" class=\"pid\"></i>The <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> operates in a consensus step and the values that we are tracking are already publicly accessible.<a href=\"#p_50\" class=\"pid\">50</a></p>\n<p><i id=\"p_51\" class=\"pid\"></i>To easily view any of our values, we should declare them as <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">Views</span></span> and include them in the <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.define</span></span> block of our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span>.<a href=\"#p_51\" class=\"pid\">51</a></p>\n<p><i id=\"p_52\" class=\"pid\"></i>In the following examples from <a href=\"https://github.com/reach-sh/reach-lang/blob/master/examples/rsvp-6-vevt/index.rsh\" target=\"_blank\">rsvp-6-vevt</a> we are tracking <code>howMany</code> users have called our <code>register</code> function.<a href=\"#p_52\" class=\"pid\">52</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/rsvp-6-vevt/index.rsh\">/examples/rsvp-6-vevt/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const [ done, howMany ] =\n    parallelReduce([ false, 0 ])\n    .define(() => {\n      Info.howMany.set(howMany);\n    })\n    .invariant( Guests.size() == howMany, &quot;howMany accurate&quot; )\n    .invariant( balance() == howMany * reservation, &quot;balance accurate&quot; )\n    .while( ! ( done &amp;&amp; howMany == 0 ) )\" href=\"#\" id=\"copyBtn8\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"44\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> [ </span><span style=\"color: var(--shiki-token-constant)\">done</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">howMany</span><span style=\"color: var(--shiki-color-text)\"> ] </span><span style=\"color: var(--shiki-token-keyword)\">=</span></li><li value=\"45\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-token-function)\">parallelReduce</span></a><span style=\"color: var(--shiki-color-text)\">([ </span><a href=\"/rsh/compute/#rsh_false\" title=\"rsh: false\"><span style=\"color: var(--shiki-token-constant)\">false</span></a><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\"> ])</span></li><li value=\"46\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.define\" title=\"rsh: parallelReduce.define\"><span style=\"color: var(--shiki-token-function)\">.define</span></a><span style=\"color: var(--shiki-color-text)\">(() </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"47\"><span style=\"color: var(--shiki-color-text)\">      </span><span style=\"color: var(--shiki-token-constant)\">Info</span><span style=\"color: var(--shiki-token-function)\">.</span><span style=\"color: var(--shiki-token-constant)\">howMany</span><a href=\"/rsh/compute/#rsh_set\" title=\"rsh: set\"><span style=\"color: var(--shiki-token-function)\">.set</span></a><span style=\"color: var(--shiki-color-text)\">(howMany);</span></li><li value=\"48\"><span style=\"color: var(--shiki-color-text)\">    })</span></li><li value=\"49\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">( </span><span style=\"color: var(--shiki-token-constant)\">Guests</span><a href=\"/rsh/compute/#rsh_size\" title=\"rsh: size\"><span style=\"color: var(--shiki-token-function)\">.size</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> howMany</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"howMany accurate\"</span><span style=\"color: var(--shiki-color-text)\"> )</span></li><li value=\"50\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">( </span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> howMany </span><a href=\"/rsh/compute/#rsh_*\" title=\"rsh: *\"><span style=\"color: var(--shiki-token-keyword)\">*</span></a><span style=\"color: var(--shiki-color-text)\"> reservation</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"balance accurate\"</span><span style=\"color: var(--shiki-color-text)\"> )</span></li><li value=\"51\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.while\" title=\"rsh: parallelReduce.while\"><span style=\"color: var(--shiki-token-function)\">.while</span></a><span style=\"color: var(--shiki-color-text)\">( </span><a href=\"/rsh/compute/#rsh_!\" title=\"rsh: !\"><span style=\"color: var(--shiki-token-keyword)\">!</span></a><span style=\"color: var(--shiki-color-text)\"> ( done </span><a href=\"/rsh/compute/#rsh_&amp;&amp;\" title=\"rsh: &amp;&amp;\"><span style=\"color: var(--shiki-token-keyword)\">&amp;&amp;</span></a><span style=\"color: var(--shiki-color-text)\"> howMany </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\"> ) )</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_53\" class=\"pid\"></i>Line 44 declares our loop variables.<a href=\"#p_53\" class=\"pid\">53</a></li>\n  <li><i id=\"p_54\" class=\"pid\"></i>Line 45 initializes values for those variables inside our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span>.<a href=\"#p_54\" class=\"pid\">54</a></li>\n  <li><i id=\"p_55\" class=\"pid\"></i>Line 46 starts the <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.define</span></span> block.<a href=\"#p_55\" class=\"pid\">55</a></li>\n  <li><i id=\"p_56\" class=\"pid\"></i>Line 47 is where we set the <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_View\" title=\"rsh: View\"><span style=\"color: var(--shiki-color-text)\">View</span></a></span> related to our value. In this case, <code>howMany</code> users have registered.<a href=\"#p_56\" class=\"pid\">56</a></li>\n  <li><i id=\"p_57\" class=\"pid\"></i>Lines 49-50 are for our <a href=\"/guide/loop-invs/#guide-loop-invs\">loop invariants</a>.<a href=\"#p_57\" class=\"pid\">57</a></li>\n  <li><i id=\"p_58\" class=\"pid\"></i>Line 51 is our loop condition.<a href=\"#p_58\" class=\"pid\">58</a></li>\n</ul>\n<p><i id=\"p_59\" class=\"pid\"></i>The <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> is going to leave our DApp in a state where API members can call our function and update the values, but also allow <code>howMany</code> to be accesible in the frontend with a call to the <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_View\" title=\"rsh: View\"><span style=\"color: var(--shiki-color-text)\">View</span></a></span>.<a href=\"#p_59\" class=\"pid\">59</a></p>\n<p><i id=\"p_60\" class=\"pid\"></i>More information on accessing <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">Views</span></span> from the frontend can be found at <span class=\"snip\"><a href=\"/frontend/#js_ctc\" title=\"js: ctc\"><span style=\"color: var(--shiki-token-constant)\">ctc</span></a><a href=\"/frontend/#js_ctc.views\" title=\"js: ctc.views\"><span style=\"color: var(--shiki-color-text)\">.views</span></a></span>.<a href=\"#p_60\" class=\"pid\">60</a></p>\n<p><i id=\"p_61\" class=\"pid\"></i>Now, what if we want the user to pay some amount to access this function?<a href=\"#p_61\" class=\"pid\">61</a></p>\n<h2 id=\"pay-the-pied-parallelreduce\" class=\"refHeader\">Pay the Pied ParallelReduce<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#pay-the-pied-parallelreduce\"><span class=\"icon icon-link\"></span></a></h2>\n<p><i id=\"p_62\" class=\"pid\"></i>For network tokens, we can just change the zero from our counter program to some amount.<a href=\"#p_62\" class=\"pid\">62</a></p>\n<p><i id=\"p_63\" class=\"pid\"></i>In the following example from <a href=\"https://github.com/reach-sh/reach-lang/blob/master/examples/ticket-sales/index.rsh\" target=\"_blank\">ticket-sales</a>, the seller first sets some <code>cost</code> for the ticket and we include this for the <code>PAY_EXPR</code>.<a href=\"#p_63\" class=\"pid\">63</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/ticket-sales/index.rsh\">/examples/ticket-sales/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(B.buyTicket, () => {\n      check(ticketsSold != supply, &quot;sorry, out of tickets&quot;);\n      return[cost, (ret) => {\n        transfer(1, tok).to(this);\n        ret(null);\n        return [ticketsSold + 1];\n      }];\n    });\" href=\"#\" id=\"copyBtn9\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"29\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.buyTicket</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"30\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(ticketsSold </span><a href=\"/rsh/compute/#rsh_!=\" title=\"rsh: !=\"><span style=\"color: var(--shiki-token-keyword)\">!=</span></a><span style=\"color: var(--shiki-color-text)\"> supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, out of tickets\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"31\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[cost</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"32\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok)</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"33\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"34\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ticketsSold </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">];</span></li><li value=\"35\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"36\"><span style=\"color: var(--shiki-color-text)\">    });</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_64\" class=\"pid\"></i>Line 31 is the outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> and will prompt the user to pay <code>cost</code> at their wallet interface to execute the consensus code.<a href=\"#p_64\" class=\"pid\">64</a></li>\n</ul>\n<p><i id=\"p_65\" class=\"pid\"></i>In the <a href=\"https://github.com/reach-sh/reach-lang/blob/master/examples/rsvp-6-vevt/index.rsh\" target=\"_blank\">rsvp-6-vevt</a> example, we ask the user to pay <code>reservation</code>.<a href=\"#p_65\" class=\"pid\">65</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/rsvp-6-vevt/index.rsh\">/examples/rsvp-6-vevt/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(Guest.register, () => {\n      check(! done, &quot;event started&quot;);\n      check(isNone(Guests[this]), &quot;already registered&quot;);\n      return [ reservation, (ret) => {\n        enforce( thisConsensusTime() < deadline, &quot;too late&quot; );\n        Guests[this] = true;\n        Notify.register(this);\n        ret(null);\n        return [ false, howMany + 1 ];\n      } ];\n    })\" href=\"#\" id=\"copyBtn10\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"52\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">Guest</span><span style=\"color: var(--shiki-color-text)\">.register</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"53\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_!\" title=\"rsh: !\"><span style=\"color: var(--shiki-token-keyword)\">!</span></a><span style=\"color: var(--shiki-color-text)\"> done</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"event started\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"54\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isNone\" title=\"rsh: isNone\"><span style=\"color: var(--shiki-token-function)\">isNone</span></a><span style=\"color: var(--shiki-color-text)\">(Guests[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"already registered\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"55\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ reservation</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"56\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_enforce\" title=\"rsh: enforce\"><span style=\"color: var(--shiki-token-function)\">enforce</span></a><span style=\"color: var(--shiki-color-text)\">( </span><a href=\"/rsh/compute/#rsh_thisConsensusTime\" title=\"rsh: thisConsensusTime\"><span style=\"color: var(--shiki-token-function)\">thisConsensusTime</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_%3C\" title=\"rsh: <\"><span style=\"color: var(--shiki-token-keyword)\">&lt;</span></a><span style=\"color: var(--shiki-color-text)\"> deadline</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"too late\"</span><span style=\"color: var(--shiki-color-text)\"> );</span></li><li value=\"57\"><span style=\"color: var(--shiki-color-text)\">        Guests[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_true\" title=\"rsh: true\"><span style=\"color: var(--shiki-token-constant)\">true</span></a><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"58\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-constant)\">Notify</span><span style=\"color: var(--shiki-token-function)\">.register</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"59\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_null\" title=\"rsh: null\"><span style=\"color: var(--shiki-token-constant)\">null</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"60\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [ </span><a href=\"/rsh/compute/#rsh_false\" title=\"rsh: false\"><span style=\"color: var(--shiki-token-constant)\">false</span></a><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> howMany </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\"> ];</span></li><li value=\"61\"><span style=\"color: var(--shiki-color-text)\">      } ];</span></li><li value=\"62\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_66\" class=\"pid\"></i>Line 55 starts the outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> and asks the user to pay <code>reservation</code> before executing the consesus step.<a href=\"#p_66\" class=\"pid\">66</a></li>\n</ul>\n<p><i id=\"p_67\" class=\"pid\"></i>All of our examples have so far demonstrated using network tokens. But what if you need the user to pay the contract in a non-network token?<a href=\"#p_67\" class=\"pid\">67</a></p>\n<h4 id=\"non-network-tokens\" class=\"refHeader\">Non-network Tokens<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#non-network-tokens\"><span class=\"icon icon-link\"></span></a></h4>\n<p><i id=\"p_68\" class=\"pid\"></i>Any token that is not the native token of a protocol is considered a non-network token.<a href=\"#p_68\" class=\"pid\">68</a></p>\n<p><i id=\"p_69\" class=\"pid\"></i>The gas or txn fees, are paid in network tokens.<a href=\"#p_69\" class=\"pid\">69</a></p>\n<p>\n  <i id=\"p_70\" class=\"pid\"></i>Examples of non-network tokens include all Contract Tokens on ETH (ERC20, ERC721, etc..) and all ASA Tokens on Algorand based networks.\n  <a href=\"/guide/nntoks/#guide-nntoks\">How do network and non-network tokens differ?</a><a href=\"#p_70\" class=\"pid\">70</a>\n</p>\n<p><i id=\"p_71\" class=\"pid\"></i>First, we need to teach the Smart Contract about our non-network <span class=\"snip\"><a href=\"/rsh/compute/#rsh_Token\" title=\"rsh: Token\"><span style=\"color: var(--shiki-color-text)\">Token</span></a></span>. This means providing it from the frontend (usually the Admin does this) -- and <span class=\"snip\"><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-color-text)\">publish</span></a></span>ing this token ID.<a href=\"#p_71\" class=\"pid\">71</a></p>\n<div class=\"note\">\n  <p>\n    <i id=\"p_72\" class=\"pid\"></i>On ETH the token ID is an Address.\n    On Algorand it is a unique ID number.<a href=\"#p_72\" class=\"pid\">72</a>\n  </p>\n</div>\n<p><i id=\"p_73\" class=\"pid\"></i>We will examine the <a href=\"https://github.com/reach-sh/reach-lang/blob/master/examples/point-of-sale/index.rsh\" target=\"_blank\">point-of-sale</a> example for this.<a href=\"#p_73\" class=\"pid\">73</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  A.only(() => {\n   const {min, tok, supply} = declassify(interact.params);\n  });\n  A.publish(min, tok, supply);\n  commit();\n  A.pay([[supply, tok]])\" href=\"#\" id=\"copyBtn11\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_only\" title=\"rsh: only\"><span style=\"color: var(--shiki-token-function)\">.only</span></a><span style=\"color: var(--shiki-color-text)\">(() </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"20\"><span style=\"color: var(--shiki-color-text)\">   </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> {</span><a href=\"/rsh/compute/#rsh_min\" title=\"rsh: min\"><span style=\"color: var(--shiki-token-constant)\">min</span></a><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">tok</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/consensus/#rsh_supply\" title=\"rsh: supply\"><span style=\"color: var(--shiki-token-constant)\">supply</span></a><span style=\"color: var(--shiki-color-text)\">} </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/local/#rsh_declassify\" title=\"rsh: declassify\"><span style=\"color: var(--shiki-token-function)\">declassify</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-color-text)\">.params);</span></li><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">  });</span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-token-function)\">.publish</span></a><span style=\"color: var(--shiki-color-text)\">(min</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> supply);</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/consensus/#rsh_commit\" title=\"rsh: commit\"><span style=\"color: var(--shiki-token-function)\">commit</span></a><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-token-function)\">.pay</span></a><span style=\"color: var(--shiki-color-text)\">([[supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]])</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_74\" class=\"pid\"></i>Line 19 starts a local step for <code>A</code>.<a href=\"#p_74\" class=\"pid\">74</a></li>\n  <li><i id=\"p_75\" class=\"pid\"></i>Line 20 unpacks values from the frontend <code>params</code> object.<a href=\"#p_75\" class=\"pid\">75</a></li>\n  <li><i id=\"p_76\" class=\"pid\"></i>Line 22 <span class=\"snip\"><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-color-text)\">publish</span></a></span>es these values to the blockchain.<a href=\"#p_76\" class=\"pid\">76</a></li>\n</ul>\n<div class=\"note\">\n  <p><i id=\"p_77\" class=\"pid\"></i>We cannot attach the <span class=\"snip\"><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-token-function)\">.pay</span></a><span style=\"color: var(--shiki-color-text)\">([[supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]])</span></span> to the first <span class=\"snip\"><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-color-text)\">publish</span></a></span> of the DApp. This is because the Smart Contract doesn't yet know of our token. We first need to complete a <span class=\"snip\"><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-color-text)\">publish</span></a></span> of the token ID.<a href=\"#p_77\" class=\"pid\">77</a></p>\n  <p><i id=\"p_78\" class=\"pid\"></i>Reach supports network tokens by default, which is why this constraint does not exist when paying network tokens.<a href=\"#p_78\" class=\"pid\">78</a></p>\n</div>\n<p><i id=\"p_79\" class=\"pid\"></i>You may have noticed the syntactic Tuple in the <span class=\"snip\"><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-color-text)\">.pay</span></a></span>.<a href=\"#p_79\" class=\"pid\">79</a></p>\n<p><i id=\"p_80\" class=\"pid\"></i><span class=\"snip\"><a href=\"/rsh/compute/#rsh_Token\" title=\"rsh: Token\"><span style=\"color: var(--shiki-color-text)\">Token</span></a></span> IDs and the amounts to be paid need to be specified in <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">Tuples</span></span>.<a href=\"#p_80\" class=\"pid\">80</a></p>\n<p><i id=\"p_81\" class=\"pid\"></i>The first argument is the default network token and is synthesized for you, just specify the quantity -- if you leave the quantity out it will be synthesized to zero for you.<a href=\"#p_81\" class=\"pid\">81</a></p>\n<p><i id=\"p_82\" class=\"pid\"></i>This means <span class=\"snip\"><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-token-function)\">.pay</span></a><span style=\"color: var(--shiki-color-text)\">([[supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]])</span></span> is equal to <span class=\"snip\"><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-token-function)\">.pay</span></a><span style=\"color: var(--shiki-color-text)\">([</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]])</span></span>. Where zero specifies the number of network tokens.<a href=\"#p_82\" class=\"pid\">82</a></p>\n<p><i id=\"p_83\" class=\"pid\"></i>This syntax will come up again.<a href=\"#p_83\" class=\"pid\">83</a></p>\n<p><i id=\"p_84\" class=\"pid\"></i>This particular program sells these as loyalty tokens, but also allows the user to return the token in the event of a refund.<a href=\"#p_84\" class=\"pid\">84</a></p>\n<p><i id=\"p_85\" class=\"pid\"></i>This means that our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> will need to <em>accept</em> these non-network tokens as payment in our API member function.<a href=\"#p_85\" class=\"pid\">85</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const [tokensSold, total] = parallelReduce([0, 0])\n    .paySpec([tok])\n    .invariant(pMap.sum() == total, &quot;tracking total wrong&quot;)\n    .invariant(balance() == total, &quot;network token balance wrong&quot;)\n    .invariant(balance(tok) == supply - tokensSold, &quot;non-network token balance wrong&quot;)\n    .while(tokensSold < supply)\" href=\"#\" id=\"copyBtn12\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"28\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">tokensSold</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">total</span><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-token-function)\">parallelReduce</span></a><span style=\"color: var(--shiki-color-text)\">([</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\">])</span></li><li value=\"29\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.paySpec\" title=\"rsh: parallelReduce.paySpec\"><span style=\"color: var(--shiki-token-function)\">.paySpec</span></a><span style=\"color: var(--shiki-color-text)\">([tok])</span></li><li value=\"30\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">pMap</span><a href=\"/rsh/compute/#rsh_sum\" title=\"rsh: sum\"><span style=\"color: var(--shiki-token-function)\">.sum</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> total</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"tracking total wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"31\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> total</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"network token balance wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"32\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">(tok) </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> supply </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> tokensSold</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"non-network token balance wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"33\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.while\" title=\"rsh: parallelReduce.while\"><span style=\"color: var(--shiki-token-function)\">.while</span></a><span style=\"color: var(--shiki-color-text)\">(tokensSold </span><a href=\"/rsh/compute/#rsh_%3C\" title=\"rsh: <\"><span style=\"color: var(--shiki-token-keyword)\">&lt;</span></a><span style=\"color: var(--shiki-color-text)\"> supply)</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_86\" class=\"pid\"></i>Line 28 starts our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span>.<a href=\"#p_86\" class=\"pid\">86</a></li>\n  <li><i id=\"p_87\" class=\"pid\"></i>Line 29 is new. <span class=\"snip\"><a href=\"/rsh/step/#rsh_paySpec\" title=\"rsh: paySpec\"><span style=\"color: var(--shiki-token-function)\">.paySpec</span></a><span style=\"color: var(--shiki-color-text)\">([tok])</span></span> tells our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> that it can also accept payment in this non-network token.<a href=\"#p_87\" class=\"pid\">87</a></li>\n</ul>\n<div class=\"note\">\n  <p><i id=\"p_88\" class=\"pid\"></i>This is structured as an array, so you can just list out the other tokens seperated by a comma.<a href=\"#p_88\" class=\"pid\">88</a></p>\n  <p><span class=\"snip\"><a href=\"/rsh/step/#rsh_paySpec\" title=\"rsh: paySpec\"><span style=\"color: var(--shiki-token-function)\">.paySpec</span></a><span style=\"color: var(--shiki-color-text)\">([tok1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok2])</span></span></p>\n  <p><i id=\"p_89\" class=\"pid\"></i>Just be sure they have been <span class=\"snip\"><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-color-text)\">publish</span></a></span>ed and you have Reach <span class=\"snip\"><a href=\"/rsh/local/#rsh_assume\" title=\"rsh: assume\"><span style=\"color: var(--shiki-token-function)\">assume</span></a><span style=\"color: var(--shiki-color-text)\">(tok1 </span><a href=\"/rsh/compute/#rsh_!=\" title=\"rsh: !=\"><span style=\"color: var(--shiki-token-keyword)\">!=</span></a><span style=\"color: var(--shiki-color-text)\"> tok2)</span></span> for each token.<a href=\"#p_89\" class=\"pid\">89</a></p>\n</div>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(B.purchase, (purchasePrice) => {\n      check(tokensSold != supply, &quot;sorry, out of tickets&quot;);\n      check(isNone(pMap[this]), &quot;sorry, you are already in this list&quot;);\n      check(purchasePrice >= min, &quot;sorry, amount too low&quot;);\n      return[[purchasePrice, [0, tok]], (ret) => {\n        pMap[this] = purchasePrice;\n        const sold = tokensSold + 1;\n        transfer(1, tok).to(this);\n        ret(sold);\n        return [sold, total + purchasePrice];\n      }];\n    })\" href=\"#\" id=\"copyBtn13\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"34\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.purchase</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (purchasePrice) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"35\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(tokensSold </span><a href=\"/rsh/compute/#rsh_!=\" title=\"rsh: !=\"><span style=\"color: var(--shiki-token-keyword)\">!=</span></a><span style=\"color: var(--shiki-color-text)\"> supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, out of tickets\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"36\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isNone\" title=\"rsh: isNone\"><span style=\"color: var(--shiki-token-function)\">isNone</span></a><span style=\"color: var(--shiki-color-text)\">(pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, you are already in this list\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"37\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(purchasePrice </span><a href=\"/rsh/compute/#rsh_%3E=\" title=\"rsh: >=\"><span style=\"color: var(--shiki-token-keyword)\">&gt;=</span></a><span style=\"color: var(--shiki-color-text)\"> min</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, amount too low\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"38\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[[purchasePrice</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"39\"><span style=\"color: var(--shiki-color-text)\">        pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> purchasePrice;</span></li><li value=\"40\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">sold</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> tokensSold </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"41\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok)</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"42\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(sold);</span></li><li value=\"43\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [sold</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> total </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> purchasePrice];</span></li><li value=\"44\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"45\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_90\" class=\"pid\"></i>Line 34 specifies the <code>API_EXPR</code> and takes an input <code>purchasePrice</code> from the caller.<a href=\"#p_90\" class=\"pid\">90</a></li>\n  <li><i id=\"p_91\" class=\"pid\"></i>Lines 35-37 perform various verification checks.<a href=\"#p_91\" class=\"pid\">91</a></li>\n  <li><i id=\"p_92\" class=\"pid\"></i>Line 38 starts our outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span>. This is where we need to specify the <code>PAY_EXPR</code>, but it also needs to account for our non-network token syntax. <code>[purchasePrice, [0, tok]]</code> has the user pay the <code>purchasePrice</code> in network tokens and zero of our non-network token.<a href=\"#p_92\" class=\"pid\">92</a></li>\n</ul>\n<p><i id=\"p_93\" class=\"pid\"></i>Now let's accept our non-network token from the user in the event of a refund.<a href=\"#p_93\" class=\"pid\">93</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(B.refund, () => {\n      check(isSome(pMap[this]), &quot;sorry, you are not in the list&quot;);\n      return[[0, [1, tok]], (ret) => {\n        const paid = fromSome(pMap[this], 0);\n        transfer(paid).to(this);\n        ret(paid);\n        delete pMap[this];\n        return[tokensSold - 1, total - paid]\n      }];\n    });\" href=\"#\" id=\"copyBtn14\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"46\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.refund</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"47\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isSome\" title=\"rsh: isSome\"><span style=\"color: var(--shiki-token-function)\">isSome</span></a><span style=\"color: var(--shiki-color-text)\">(pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, you are not in the list\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"48\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[[</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"49\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">paid</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_fromSome\" title=\"rsh: fromSome\"><span style=\"color: var(--shiki-token-function)\">fromSome</span></a><span style=\"color: var(--shiki-color-text)\">(pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"50\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">(paid)</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"51\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(paid);</span></li><li value=\"52\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/errors/#rsh_delete\" title=\"rsh: delete\"><span style=\"color: var(--shiki-token-keyword)\">delete</span></a><span style=\"color: var(--shiki-color-text)\"> pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">];</span></li><li value=\"53\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[tokensSold </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> total </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> paid]</span></li><li value=\"54\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"55\"><span style=\"color: var(--shiki-color-text)\">    });</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_94\" class=\"pid\"></i>Line 48 is our outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span>. Notice the same syntax as the <code>purchase</code> function, but with different amounts. Now one <code>tok</code> is coming into the contract upon approval of the transaction.<a href=\"#p_94\" class=\"pid\">94</a></li>\n</ul>\n<p><i id=\"p_95\" class=\"pid\"></i>Hopefully this guide has helped you better understand the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span>.<a href=\"#p_95\" class=\"pid\">95</a></p>\n<p><i id=\"p_96\" class=\"pid\"></i>If you still have questions, Reach out to us in <a href=\"https://discord.gg/kbfNkdaMhD\" target=\"_blank\">Discord</a>!<a href=\"#p_96\" class=\"pid\">96</a></p>","<ul><li class=\"dynamic\">\n    <a href=\"#guide-parallelReduce\">parallelReduce Guide</a>\n    <ul class=\"dynamic\">\n      <li class=\"dynamic\">\n        <a href=\"#description\">Description</a>\n        <ul class=\"dynamic\">\n          <li class=\"dynamic\">\n            <a href=\"#api-inputs-and-returns\">API Inputs and Returns</a>\n          </li>\n          <li class=\"dynamic\">\n            <a href=\"#api_-vs-api-syntax\">.api_ vs .api Syntax</a>\n            <ul class=\"dynamic\">\n              <li class=\"dynamic\"><a href=\"#api_\">.api_</a></li>\n              <li class=\"dynamic\"><a href=\"#api\">.api</a></li>\n            </ul>\n          </li>\n          <li class=\"dynamic\">\n            <a href=\"#define-your-views\">.define your Views</a>\n          </li>\n        </ul>\n      </li>\n      <li class=\"dynamic\">\n        <a href=\"#pay-the-pied-parallelreduce\">Pay the Pied ParallelReduce</a>\n        <ul class=\"dynamic\">\n          <li class=\"dynamic\">\n            <ul class=\"dynamic\">\n              <li class=\"dynamic\"><a href=\"#non-network-tokens\">Non-network Tokens</a></li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n    </ul>\n  </li></ul>"]