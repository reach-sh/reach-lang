[{"bookPath":"","title":"Point of Sale","titleId":"point-of-sale","hasOtp":true,"hasPageHeader":true},"<h1 id=\"point-of-sale\" class=\"refHeader\">Point of Sale<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#point-of-sale\"><span class=\"icon icon-link\"></span></a></h1>\n<p><i id=\"p_0\" class=\"pid\"></i>This tutorial will walk you through creating a business point-of-sale machine, like Toast or Square.<a href=\"#p_0\" class=\"pid\">0</a></p>\n<p><i id=\"p_1\" class=\"pid\"></i>It assumes that you are comfortable with writing simple Reach DApps and have already completed one or two of our <a href=\"/tut/#tuts\">tutorials</a>.<a href=\"#p_1\" class=\"pid\">1</a></p>\n<p><i id=\"p_2\" class=\"pid\"></i>Complete all of the tutorials to become a Reach rockstar.<a href=\"#p_2\" class=\"pid\">2</a></p>\n<h2 id=\"program-design\" class=\"refHeader\">Program Design<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#program-design\"><span class=\"icon icon-link\"></span></a></h2>\n<p><i id=\"p_3\" class=\"pid\"></i>The main function of our DApp will be to process sale transactions. This means we will need to implement functions for purchases and refunds.<a href=\"#p_3\" class=\"pid\">3</a></p>\n<p><i id=\"p_4\" class=\"pid\"></i>We will allow purchases of varying amounts for different products, so we will also need to track the amount of each users purchase.<a href=\"#p_4\" class=\"pid\">4</a></p>\n<p><i id=\"p_5\" class=\"pid\"></i>It would also be good to reward our business' visitors with a Loyalty Token. Future programs could use this Loyalty Token to gate access to special features or events.<a href=\"#p_5\" class=\"pid\">5</a></p>\n<p><i id=\"p_6\" class=\"pid\"></i>When designing our DApp we need to consider possibilities for the length of our contract.<a href=\"#p_6\" class=\"pid\">6</a></p>\n<p><i id=\"p_7\" class=\"pid\"></i>Given the Loyalty Token, it will be best for our implementation to make contract functions accessible until we run out of Loyalty Tokens.<a href=\"#p_7\" class=\"pid\">7</a></p>\n<h3 id=\"here-is-the-general-flow-of-our-dapp\" class=\"refHeader\">Here is the general flow of our DApp:<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#here-is-the-general-flow-of-our-dapp\"><span class=\"icon icon-link\"></span></a></h3>\n<ol>\n  <li><i id=\"p_8\" class=\"pid\"></i>Admin gives parameters and deploys contract.<a href=\"#p_8\" class=\"pid\">8</a></li>\n  <li><i id=\"p_9\" class=\"pid\"></i>Admin deposits non-network Loyalty Tokens into contract.<a href=\"#p_9\" class=\"pid\">9</a></li>\n  <li><i id=\"p_10\" class=\"pid\"></i>Contract exposes API functions.<a href=\"#p_10\" class=\"pid\">10</a></li>\n  <li><i id=\"p_11\" class=\"pid\"></i>Users purchase items in our store.<a href=\"#p_11\" class=\"pid\">11</a></li>\n  <li><i id=\"p_12\" class=\"pid\"></i>Users are offered a refund window.<a href=\"#p_12\" class=\"pid\">12</a></li>\n  <li><i id=\"p_13\" class=\"pid\"></i>Close access to API functions when Loyalty Token balance is zero.<a href=\"#p_13\" class=\"pid\">13</a></li>\n  <li><i id=\"p_14\" class=\"pid\"></i>Transfer network tokens to Admin.<a href=\"#p_14\" class=\"pid\">14</a></li>\n  <li><i id=\"p_15\" class=\"pid\"></i>Terminate contract.<a href=\"#p_15\" class=\"pid\">15</a></li>\n</ol>\n<h2 id=\"where-the-users-at\" class=\"refHeader\">Where the users at?<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#where-the-users-at\"><span class=\"icon icon-link\"></span></a></h2>\n<p><i id=\"p_16\" class=\"pid\"></i>At this point of designing our Reach DApp, we need to ask ourselves how many and what types of users will be interacting with it.<a href=\"#p_16\" class=\"pid\">16</a></p>\n<p><i id=\"p_17\" class=\"pid\"></i>We know that we need at least one <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_Participant\" title=\"rsh: Participant\"><span style=\"color: var(--shiki-color-text)\">Participant</span></a></span> to deploy the contract and serve as our <code>Admin</code>. We can consider them our shop owner.<a href=\"#p_17\" class=\"pid\">17</a></p>\n<div class=\"note\">\n  <p><i id=\"p_18\" class=\"pid\"></i>All Reach DApps require at least one <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_Participant\" title=\"rsh: Participant\"><span style=\"color: var(--shiki-color-text)\">Participant</span></a></span>, because <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> members <em>do not</em> have the ability to deploy contracts.<a href=\"#p_18\" class=\"pid\">18</a></p>\n</div>\n<p><i id=\"p_19\" class=\"pid\"></i>The rest of our users will be customers in our shop, so they are best represented as <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span>. This will allow an unlimited number of unknown users to interact with our contract <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> member functions.<a href=\"#p_19\" class=\"pid\">19</a></p>\n<p><i id=\"p_20\" class=\"pid\"></i>Let's write some Reach code for our users.<a href=\"#p_20\" class=\"pid\">20</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"'reach 0.1';\n\nexport const main = Reach.App(() => {\n  setOptions({ ALGOExitMode: 'DeleteAndCloseOutASAs' });\n  const A = Participant('Admin', {\n    params: Object({\n      min: UInt,\n      tok: Token,\n      supply: UInt,\n    }),\n    launched: Fun([Contract], Null),\n  });\" href=\"#\" id=\"copyBtn1\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-string-expression)\">'reach 0.1'</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"2\"></li><li value=\"3\"><a href=\"/rsh/module/#rsh_export\" title=\"rsh: export\"><span style=\"color: var(--shiki-token-keyword)\">export</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">main</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/module/#rsh_Reach\" title=\"rsh: Reach\"><span style=\"color: var(--shiki-token-constant)\">Reach</span></a><a href=\"/rsh/module/#rsh_Reach.App\" title=\"rsh: Reach.App\"><span style=\"color: var(--shiki-token-function)\">.App</span></a><span style=\"color: var(--shiki-color-text)\">(() </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"4\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/appinit/#rsh_setOptions\" title=\"rsh: setOptions\"><span style=\"color: var(--shiki-token-function)\">setOptions</span></a><span style=\"color: var(--shiki-color-text)\">({ ALGOExitMode</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'DeleteAndCloseOutASAs'</span><span style=\"color: var(--shiki-color-text)\"> });</span></li><li value=\"5\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">A</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/appinit/#rsh_Participant\" title=\"rsh: Participant\"><span style=\"color: var(--shiki-token-function)\">Participant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">'Admin'</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"6\"><span style=\"color: var(--shiki-color-text)\">    params</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_Object\" title=\"rsh: Object\"><span style=\"color: var(--shiki-token-constant)\">Object</span></a><span style=\"color: var(--shiki-color-text)\">({</span></li><li value=\"7\"><span style=\"color: var(--shiki-color-text)\">      min</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> UInt</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"8\"><span style=\"color: var(--shiki-color-text)\">      tok</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> Token</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"9\"><span style=\"color: var(--shiki-color-text)\">      supply</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> UInt</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"10\"><span style=\"color: var(--shiki-color-text)\">    })</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"11\"><span style=\"color: var(--shiki-color-text)\">    launched</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_Fun\" title=\"rsh: Fun\"><span style=\"color: var(--shiki-token-function)\">Fun</span></a><span style=\"color: var(--shiki-color-text)\">([Contract]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> Null)</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"12\"><span style=\"color: var(--shiki-color-text)\">  });</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_21\" class=\"pid\"></i>Line 4 is a new feature with Reach 0.1.13; we need it because we're using boxes, you can read more about it by clicking <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_ALGOExitMode\" title=\"rsh: ALGOExitMode\"><span style=\"color: var(--shiki-color-text)\">ALGOExitMode</span></a></span>.<a href=\"#p_21\" class=\"pid\">21</a></li>\n  <li><i id=\"p_22\" class=\"pid\"></i>Line 5 declares our 'Admin' <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_Participant\" title=\"rsh: Participant\"><span style=\"color: var(--shiki-color-text)\">Participant</span></a></span>.<a href=\"#p_22\" class=\"pid\">22</a></li>\n  <li><i id=\"p_23\" class=\"pid\"></i>Line 6-9 declares data types of contract parameters.<a href=\"#p_23\" class=\"pid\">23</a></li>\n  <li><i id=\"p_24\" class=\"pid\"></i>Line 11 is our signature <code>launched</code> function, to notify the frontend that we are ready to start accepting API calls.<a href=\"#p_24\" class=\"pid\">24</a></li>\n</ul>\n<p><i id=\"p_25\" class=\"pid\"></i>Now for our <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> users.<a href=\"#p_25\" class=\"pid\">25</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const B = API('Buyer', {\n    purchase: Fun([UInt], UInt),\n    refund: Fun([], UInt),\n  });\n  init();\" href=\"#\" id=\"copyBtn2\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"13\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-function)\">API</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">'Buyer'</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"14\"><span style=\"color: var(--shiki-color-text)\">    purchase</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_Fun\" title=\"rsh: Fun\"><span style=\"color: var(--shiki-token-function)\">Fun</span></a><span style=\"color: var(--shiki-color-text)\">([UInt]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> UInt)</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"15\"><span style=\"color: var(--shiki-color-text)\">    refund</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_Fun\" title=\"rsh: Fun\"><span style=\"color: var(--shiki-token-function)\">Fun</span></a><span style=\"color: var(--shiki-color-text)\">([]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> UInt)</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"16\"><span style=\"color: var(--shiki-color-text)\">  });</span></li><li value=\"17\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/appinit/#rsh_init\" title=\"rsh: init\"><span style=\"color: var(--shiki-token-function)\">init</span></a><span style=\"color: var(--shiki-color-text)\">();</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_26\" class=\"pid\"></i>Line 13 specifies our <code>Buyer</code> as an <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span>.<a href=\"#p_26\" class=\"pid\">26</a></li>\n  <li><i id=\"p_27\" class=\"pid\"></i>Line 14-15 declare the functions that this type of user is allowed to access.<a href=\"#p_27\" class=\"pid\">27</a></li>\n  <li><i id=\"p_28\" class=\"pid\"></i>Line 17 calls <code>init()</code> to start stepping through the states of our DApp.<a href=\"#p_28\" class=\"pid\">28</a></li>\n</ul>\n<p><i id=\"p_29\" class=\"pid\"></i>Now that our users are defined, the first step from our General Flow is to get the parameters from the <code>Admin</code>.<a href=\"#p_29\" class=\"pid\">29</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  A.only(() => {\n   const {min, tok, supply} = declassify(interact.params);\n  });\n  A.publish(min, tok, supply);\n  commit();\n  A.pay([[supply, tok]])\n  A.interact.launched(getContract());\" href=\"#\" id=\"copyBtn3\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_only\" title=\"rsh: only\"><span style=\"color: var(--shiki-token-function)\">.only</span></a><span style=\"color: var(--shiki-color-text)\">(() </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"20\"><span style=\"color: var(--shiki-color-text)\">   </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> {</span><a href=\"/rsh/compute/#rsh_min\" title=\"rsh: min\"><span style=\"color: var(--shiki-token-constant)\">min</span></a><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">tok</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/consensus/#rsh_supply\" title=\"rsh: supply\"><span style=\"color: var(--shiki-token-constant)\">supply</span></a><span style=\"color: var(--shiki-color-text)\">} </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/local/#rsh_declassify\" title=\"rsh: declassify\"><span style=\"color: var(--shiki-token-function)\">declassify</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-color-text)\">.params);</span></li><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">  });</span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-token-function)\">.publish</span></a><span style=\"color: var(--shiki-color-text)\">(min</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> supply);</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/consensus/#rsh_commit\" title=\"rsh: commit\"><span style=\"color: var(--shiki-token-function)\">commit</span></a><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-token-function)\">.pay</span></a><span style=\"color: var(--shiki-color-text)\">([[supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]])</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-constant)\">A</span><span style=\"color: var(--shiki-token-function)\">.</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-token-function)\">.launched</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_getContract\" title=\"rsh: getContract\"><span style=\"color: var(--shiki-token-function)\">getContract</span></a><span style=\"color: var(--shiki-color-text)\">());</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_30\" class=\"pid\"></i>Line 19 starts a local step.<a href=\"#p_30\" class=\"pid\">30</a></li>\n  <li><i id=\"p_31\" class=\"pid\"></i>Line 20 gets the parameters from the <code>Admin</code> frontend and unpacks them into respective constants.<a href=\"#p_31\" class=\"pid\">31</a></li>\n  <li><i id=\"p_32\" class=\"pid\"></i>Line 22 <span class=\"snip\"><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-color-text)\">publish</span></a></span>es these identifiers to the blockchain.<a href=\"#p_32\" class=\"pid\">32</a></li>\n  <li><i id=\"p_33\" class=\"pid\"></i>Line 23 has us <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_commit\" title=\"rsh: commit\"><span style=\"color: var(--shiki-token-function)\">commit</span></a><span style=\"color: var(--shiki-color-text)\">()</span></span> to move out of consensus. Now our contract is aware of <code>tok</code> and it can be paid into the contract.<a href=\"#p_33\" class=\"pid\">33</a></li>\n  <li><i id=\"p_34\" class=\"pid\"></i>Line 24 <span class=\"snip\"><a href=\"/rsh/step/#rsh_pay\" title=\"rsh: pay\"><span style=\"color: var(--shiki-color-text)\">pay</span></a></span>s the total supply of Loyalty Tokens into the contract.<a href=\"#p_34\" class=\"pid\">34</a></li>\n  <li><i id=\"p_35\" class=\"pid\"></i>Line 25 Notifies the frontend that our contract is ready to start accepting <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> calls.<a href=\"#p_35\" class=\"pid\">35</a></li>\n</ul>\n<p><i id=\"p_36\" class=\"pid\"></i>The first two steps of our General Flow are now complete.<a href=\"#p_36\" class=\"pid\">36</a></p>\n<p><i id=\"p_37\" class=\"pid\"></i>Now is a good time to get into the frontend (<code>.mjs</code>) test suite and get that started.<a href=\"#p_37\" class=\"pid\">37</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.mjs\">/examples/point-of-sale/index.mjs</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"import { loadStdlib } from &quot;@reach-sh/stdlib&quot;;\nimport * as backend from './build/index.main.mjs';\nconst stdlib = loadStdlib({REACH_NO_WARN: 'Y'});\nconst MIN_PRICE = 10;\nconst USERS = 10;\nconst FAILS = 2;\n\nconst accA = await stdlib.newTestAccount(stdlib.parseCurrency(5000));\nconst ctcA = accA.contract(backend);\nconst loyalTok = await stdlib.launchToken(accA, &quot;Loyalty&quot;, &quot;LYL&quot;, {supply: USERS});\n\nconsole.log(`Welcome to the point-of-sale machine. This machine processes\npayments of varying amounts and rewards each purchase with a loyalty token.\nThe pos will also process refunds, which return network tokens to the customer,\nand loyalty tokens to the contract.\\n`);\" href=\"#\" id=\"copyBtn4\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import\" title=\"js: import\"><span style=\"color: var(--shiki-token-keyword)\">import</span></a><span style=\"color: var(--shiki-color-text)\"> { loadStdlib } </span><span style=\"color: var(--shiki-token-keyword)\">from</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"@reach-sh/stdlib\"</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"2\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import\" title=\"js: import\"><span style=\"color: var(--shiki-token-keyword)\">import</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">*</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">as</span><span style=\"color: var(--shiki-color-text)\"> backend </span><span style=\"color: var(--shiki-token-keyword)\">from</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'./build/index.main.mjs'</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"3\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_loadStdlib\" title=\"js: loadStdlib\"><span style=\"color: var(--shiki-token-function)\">loadStdlib</span></a><span style=\"color: var(--shiki-color-text)\">({REACH_NO_WARN</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'Y'</span><span style=\"color: var(--shiki-color-text)\">});</span></li><li value=\"4\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">MIN_PRICE</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">10</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"5\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">USERS</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">10</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"6\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">FAILS</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">2</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"7\"></li><li value=\"8\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">accA</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><a href=\"/frontend/#js_stdlib.newTestAccount\" title=\"js: stdlib.newTestAccount\"><span style=\"color: var(--shiki-token-function)\">.newTestAccount</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><a href=\"/frontend/#js_parseCurrency\" title=\"js: parseCurrency\"><span style=\"color: var(--shiki-token-function)\">.parseCurrency</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">5000</span><span style=\"color: var(--shiki-color-text)\">));</span></li><li value=\"9\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">ctcA</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">accA</span><a href=\"/frontend/#js_contract\" title=\"js: contract\"><span style=\"color: var(--shiki-token-function)\">.contract</span></a><span style=\"color: var(--shiki-color-text)\">(backend);</span></li><li value=\"10\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">loyalTok</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><a href=\"/frontend/#js_stdlib.launchToken\" title=\"js: stdlib.launchToken\"><span style=\"color: var(--shiki-token-function)\">.launchToken</span></a><span style=\"color: var(--shiki-color-text)\">(accA</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"Loyalty\"</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"LYL\"</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> {supply</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">USERS</span><span style=\"color: var(--shiki-color-text)\">});</span></li><li value=\"11\"></li><li value=\"12\"><span style=\"color: var(--shiki-token-constant)\">console</span><span style=\"color: var(--shiki-token-function)\">.log</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">`Welcome to the point-of-sale machine. This machine processes</span></li><li value=\"13\"><span style=\"color: var(--shiki-token-string-expression)\">payments of varying amounts and rewards each purchase with a loyalty token.</span></li><li value=\"14\"><span style=\"color: var(--shiki-token-string-expression)\">The pos will also process refunds, which return network tokens to the customer,</span></li><li value=\"15\"><span style=\"color: var(--shiki-token-string-expression)\">and loyalty tokens to the contract.\\n`</span><span style=\"color: var(--shiki-color-text)\">);</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_38\" class=\"pid\"></i>Lines 8-9 create a new account for our <code>Admin</code> and get the contract handle.<a href=\"#p_38\" class=\"pid\">38</a></li>\n  <li><i id=\"p_39\" class=\"pid\"></i>Line 10 launches our Loyalty Token, depositing the total supply to <code>accA</code>.<a href=\"#p_39\" class=\"pid\">39</a></li>\n  <li><i id=\"p_40\" class=\"pid\"></i>Lines 12-15 is a welcome message that is probably too long.<a href=\"#p_40\" class=\"pid\">40</a></li>\n</ul>\n<p><i id=\"p_41\" class=\"pid\"></i>Now let's automate our <code>Admin</code> interaction. Please pay attention to the jump in line numbers: this code goes at the bottom of your <code>mjs</code> file.<a href=\"#p_41\" class=\"pid\">41</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.mjs\">/examples/point-of-sale/index.mjs</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"await ctcA.p.Admin({\n  params: {\n    tok: loyalTok.id,\n    min: MIN_PRICE,\n    supply: USERS,\n  },\n  launched: async (contract) => {\n    console.log(`Ready at contract: ${contract}\\n`);\n    await startBuyers();\n  },\n});\nconsole.log('Exiting...');\" href=\"#\" id=\"copyBtn5\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"45\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-constant)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> ctcA.p.Admin({</span></li><li value=\"46\"><span style=\"color: var(--shiki-color-text)\">  params</span><span style=\"color: var(--shiki-token-punctuation)\">:</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"47\"><span style=\"color: var(--shiki-color-text)\">    tok</span><span style=\"color: var(--shiki-token-punctuation)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">loyalTok</span><span style=\"color: var(--shiki-color-text)\">.id</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"48\"><span style=\"color: var(--shiki-color-text)\">    min</span><span style=\"color: var(--shiki-token-punctuation)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">MIN_PRICE</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"49\"><span style=\"color: var(--shiki-color-text)\">    supply</span><span style=\"color: var(--shiki-token-punctuation)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">USERS</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"50\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"51\"><span style=\"color: var(--shiki-color-text)\">  launched</span><span style=\"color: var(--shiki-token-punctuation)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function\" title=\"js: async\"><span style=\"color: var(--shiki-token-keyword)\">async</span></a><span style=\"color: var(--shiki-color-text)\"> (contract) </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"52\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-constant)\">console</span><span style=\"color: var(--shiki-token-function)\">.log</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">`Ready at contract: </span><span style=\"color: var(--shiki-token-keyword)\">${</span><a href=\"/frontend/#js_contract\" title=\"js: contract\"><span style=\"color: var(--shiki-color-text)\">contract</span></a><span style=\"color: var(--shiki-token-keyword)\">}</span><span style=\"color: var(--shiki-token-string-expression)\">\\n`</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"53\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">startBuyers</span><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"54\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"55\"><span style=\"color: var(--shiki-color-text)\">});</span></li><li value=\"56\"><span style=\"color: var(--shiki-token-constant)\">console</span><span style=\"color: var(--shiki-token-function)\">.log</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">'Exiting...'</span><span style=\"color: var(--shiki-color-text)\">);</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_42\" class=\"pid\"></i>Line 46-49 are various parameter values provided by the Admin.<a href=\"#p_42\" class=\"pid\">42</a></li>\n  <li><i id=\"p_43\" class=\"pid\"></i>Line 51-53 is our function that will be called when the contract is ready to start accepting <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> calls. We will implement the <code>startBuyers()</code> function later.<a href=\"#p_43\" class=\"pid\">43</a></li>\n  <li><i id=\"p_44\" class=\"pid\"></i>Line 56 is useful to know that our test suite exited normally. It helps boost your moral.<a href=\"#p_44\" class=\"pid\">44</a></li>\n</ul>\n<p><i id=\"p_45\" class=\"pid\"></i>Okay, now we are ready to get back to our General Flow list!<a href=\"#p_45\" class=\"pid\">45</a></p>\n<p><i id=\"p_46\" class=\"pid\"></i>The next step is number 3, to expose <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> functions for our customers to call. This is a job for our favorite control structure <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span>.<a href=\"#p_46\" class=\"pid\">46</a></p>\n<p><i id=\"p_47\" class=\"pid\"></i>We'll start with setting up the structure.<a href=\"#p_47\" class=\"pid\">47</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  const pMap = new Map(UInt);\n  const [tokensSold, total] = parallelReduce([0, 0])\n    .paySpec([tok])\n    .invariant(pMap.sum() == total, &quot;tracking total wrong&quot;)\n    .invariant(balance() == total, &quot;network token balance wrong&quot;)\n    .invariant(balance(tok) == supply - tokensSold, &quot;non-network token balance wrong&quot;)\n    .while(tokensSold < supply)\" href=\"#\" id=\"copyBtn6\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"27\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">pMap</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_new\" title=\"rsh: new\"><span style=\"color: var(--shiki-token-keyword)\">new</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a><span style=\"color: var(--shiki-color-text)\">(UInt);</span></li><li value=\"28\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">tokensSold</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">total</span><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-token-function)\">parallelReduce</span></a><span style=\"color: var(--shiki-color-text)\">([</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\">])</span></li><li value=\"29\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.paySpec\" title=\"rsh: parallelReduce.paySpec\"><span style=\"color: var(--shiki-token-function)\">.paySpec</span></a><span style=\"color: var(--shiki-color-text)\">([tok])</span></li><li value=\"30\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">pMap</span><a href=\"/rsh/compute/#rsh_Map.sum\" title=\"rsh: Map.sum\"><span style=\"color: var(--shiki-token-function)\">.sum</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> total</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"tracking total wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"31\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">() </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> total</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"network token balance wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"32\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.invariant\" title=\"rsh: parallelReduce.invariant\"><span style=\"color: var(--shiki-token-function)\">.invariant</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">(tok) </span><a href=\"/rsh/compute/#rsh_==\" title=\"rsh: ==\"><span style=\"color: var(--shiki-token-keyword)\">==</span></a><span style=\"color: var(--shiki-color-text)\"> supply </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> tokensSold</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"non-network token balance wrong\"</span><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"33\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_parallelReduce.while\" title=\"rsh: parallelReduce.while\"><span style=\"color: var(--shiki-token-function)\">.while</span></a><span style=\"color: var(--shiki-color-text)\">(tokensSold </span><a href=\"/rsh/compute/#rsh_%3C\" title=\"rsh: <\"><span style=\"color: var(--shiki-token-keyword)\">&lt;</span></a><span style=\"color: var(--shiki-color-text)\"> supply)</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_48\" class=\"pid\"></i>Line 27 defines a new <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a></span> for storing users and their purchase amounts.<a href=\"#p_48\" class=\"pid\">48</a></li>\n  <li><i id=\"p_49\" class=\"pid\"></i>Line 28 starts our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> tracking two values, <code>tokensSold</code> and <code>total</code>. These values are initialized each to zero.<a href=\"#p_49\" class=\"pid\">49</a></li>\n  <li><i id=\"p_50\" class=\"pid\"></i>Line 29 specifies a <span class=\"snip\"><a href=\"/rsh/step/#rsh_paySpec\" title=\"rsh: paySpec\"><span style=\"color: var(--shiki-color-text)\">paySpec</span></a></span>. This is used to allow the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> to <em>accept</em> non-network tokens as payment. Notice the <a href=\"/tut/ticket-sales/#ticket-sales\">ticket-sales</a> example <em>does not</em> use <span class=\"snip\"><a href=\"/rsh/step/#rsh_paySpec\" title=\"rsh: paySpec\"><span style=\"color: var(--shiki-color-text)\">paySpec</span></a></span>, because it <em>pays out</em> non-network tokens, it <strong>does not</strong> <em>accept</em> payment in those same tokens.<a href=\"#p_50\" class=\"pid\">50</a></li>\n  <li><i id=\"p_51\" class=\"pid\"></i>Line 30-32 set up <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_invariant\" title=\"rsh: invariant\"><span style=\"color: var(--shiki-color-text)\">invariant</span></a></span>s for our loop. Each one of these is essential to compilation and the security of our program.<a href=\"#p_51\" class=\"pid\">51</a></li>\n  <li><i id=\"p_52\" class=\"pid\"></i>Line 33 sets our loop condition. This will run until the contract is out of Loyalty Tokens.<a href=\"#p_52\" class=\"pid\">52</a></li>\n</ul>\n<p><i id=\"p_53\" class=\"pid\"></i>Now that the looping construct is set up for <em>when</em> to expose these functions, we need to write the function definitions.<a href=\"#p_53\" class=\"pid\">53</a></p>\n<p><i id=\"p_54\" class=\"pid\"></i>We'll write each <code>purchase</code> and <code>refund</code> individually. First the <code>purchase</code> function.<a href=\"#p_54\" class=\"pid\">54</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(B.purchase, (purchasePrice) => {\n      check(tokensSold != supply, &quot;sorry, out of tickets&quot;);\n      check(isNone(pMap[this]), &quot;sorry, you are already in this list&quot;);\n      check(purchasePrice >= min, &quot;sorry, amount too low&quot;);\n      return[[purchasePrice, [0, tok]], (ret) => {\n        pMap[this] = purchasePrice;\n        const sold = tokensSold + 1;\n        transfer(1, tok).to(this);\n        ret(sold);\n        return [sold, total + purchasePrice];\n      }];\n    })\" href=\"#\" id=\"copyBtn7\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"34\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.purchase</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (purchasePrice) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"35\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(tokensSold </span><a href=\"/rsh/compute/#rsh_!=\" title=\"rsh: !=\"><span style=\"color: var(--shiki-token-keyword)\">!=</span></a><span style=\"color: var(--shiki-color-text)\"> supply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, out of tickets\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"36\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isNone\" title=\"rsh: isNone\"><span style=\"color: var(--shiki-token-function)\">isNone</span></a><span style=\"color: var(--shiki-color-text)\">(pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, you are already in this list\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"37\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(purchasePrice </span><a href=\"/rsh/compute/#rsh_%3E=\" title=\"rsh: >=\"><span style=\"color: var(--shiki-token-keyword)\">&gt;=</span></a><span style=\"color: var(--shiki-color-text)\"> min</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, amount too low\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"38\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[[purchasePrice</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"39\"><span style=\"color: var(--shiki-color-text)\">        pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> purchasePrice;</span></li><li value=\"40\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">sold</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> tokensSold </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"41\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok)</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"42\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(sold);</span></li><li value=\"43\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [sold</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> total </span><a href=\"/rsh/compute/#rsh_+\" title=\"rsh: +\"><span style=\"color: var(--shiki-token-keyword)\">+</span></a><span style=\"color: var(--shiki-color-text)\"> purchasePrice];</span></li><li value=\"44\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"45\"><span style=\"color: var(--shiki-color-text)\">    })</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_55\" class=\"pid\"></i>Line 34 is our function heading.<a href=\"#p_55\" class=\"pid\">55</a></li>\n  <li><i id=\"p_56\" class=\"pid\"></i>Lines 35-37 are necessary dynamic checks to be executed when this function is called. These act as gates for this function and help the Reach Verification Engine better understand the bounds of our DApp.<a href=\"#p_56\" class=\"pid\">56</a></li>\n  <li><i id=\"p_57\" class=\"pid\"></i>Line 38 sets up our outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span>. This may be the first time you have seen this syntax. Recall, the first argument for the outer return is the <code>PAY_EXPR</code> -- but we specified a <span class=\"snip\"><a href=\"/rsh/step/#rsh_paySpec\" title=\"rsh: paySpec\"><span style=\"color: var(--shiki-token-function)\">paySpec</span></a><span style=\"color: var(--shiki-color-text)\">([tok])</span></span> so we need to account for these tokens as well. The general syntax here is.. <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[[networkTokenAmount</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [amount</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> nonNetworkTok]]</span></span>. That means that our function is specifically asking the user to pay <code>purchasePrice</code> in network tokens and <code>[0, tok]</code> of our Loyalty tokens.<a href=\"#p_57\" class=\"pid\">57</a></li>\n  <li><i id=\"p_58\" class=\"pid\"></i>Line 39 adds the caller to the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a></span> with their purchase amount as the value. This allows us to look up this value later should the user need a refund.<a href=\"#p_58\" class=\"pid\">58</a></li>\n  <li><i id=\"p_59\" class=\"pid\"></i>Line 40 adds one to the <code>tokensSold</code> variable.<a href=\"#p_59\" class=\"pid\">59</a></li>\n  <li><i id=\"p_60\" class=\"pid\"></i>Line 41 <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-color-text)\">transfer</span></a></span>s a single Loyalty Token to the purchaser.<a href=\"#p_60\" class=\"pid\">60</a></li>\n  <li><i id=\"p_61\" class=\"pid\"></i>Line 42 returns our new variable to the caller.<a href=\"#p_61\" class=\"pid\">61</a></li>\n  <li><i id=\"p_62\" class=\"pid\"></i>Line 43 updates the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> LHS values<a href=\"#p_62\" class=\"pid\">62</a></li>\n</ul>\n<p><i id=\"p_63\" class=\"pid\"></i>That is all for our <code>purchase</code> function!<a href=\"#p_63\" class=\"pid\">63</a></p>\n<p><i id=\"p_64\" class=\"pid\"></i>The next piece to add is the <code>refund</code> -- but hopefully for our Admin, nobody needs one.<a href=\"#p_64\" class=\"pid\">64</a></p>\n<p><i id=\"p_65\" class=\"pid\"></i>If we do process a refund, the DApp requires the purchaser to return their Loyalty Token -- you don't get to keep both.<a href=\"#p_65\" class=\"pid\">65</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    .api_(B.refund, () => {\n      check(isSome(pMap[this]), &quot;sorry, you are not in the list&quot;);\n      return[[0, [1, tok]], (ret) => {\n        const paid = fromSome(pMap[this], 0);\n        transfer(paid).to(this);\n        ret(paid);\n        delete pMap[this];\n        return[tokensSold - 1, total - paid]\n      }];\n    });\" href=\"#\" id=\"copyBtn8\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"46\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">.api_</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">B</span><span style=\"color: var(--shiki-color-text)\">.refund</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"47\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-token-function)\">check</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_isSome\" title=\"rsh: isSome\"><span style=\"color: var(--shiki-token-function)\">isSome</span></a><span style=\"color: var(--shiki-color-text)\">(pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">])</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">\"sorry, you are not in the list\"</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"48\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[[</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> tok]]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> (ret) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"49\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">paid</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_fromSome\" title=\"rsh: fromSome\"><span style=\"color: var(--shiki-token-function)\">fromSome</span></a><span style=\"color: var(--shiki-color-text)\">(pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">]</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"50\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">(paid)</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"51\"><span style=\"color: var(--shiki-color-text)\">        </span><span style=\"color: var(--shiki-token-function)\">ret</span><span style=\"color: var(--shiki-color-text)\">(paid);</span></li><li value=\"52\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/errors/#rsh_delete\" title=\"rsh: delete\"><span style=\"color: var(--shiki-token-keyword)\">delete</span></a><span style=\"color: var(--shiki-color-text)\"> pMap[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">];</span></li><li value=\"53\"><span style=\"color: var(--shiki-color-text)\">        </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\">[tokensSold </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> total </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> paid]</span></li><li value=\"54\"><span style=\"color: var(--shiki-color-text)\">      }];</span></li><li value=\"55\"><span style=\"color: var(--shiki-color-text)\">    });</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_66\" class=\"pid\"></i>Line 46 starts our api macro <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">.api_</span></span>.<a href=\"#p_66\" class=\"pid\">66</a></li>\n  <li><i id=\"p_67\" class=\"pid\"></i>Line 47 is a dynamic check to ensure that the caller is in our <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a></span>, signifying that they have made a purchase.<a href=\"#p_67\" class=\"pid\">67</a></li>\n  <li><i id=\"p_68\" class=\"pid\"></i>Line 48 starts our outer <span class=\"snip\"><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a></span> and is the real reason we needed <span class=\"snip\"><a href=\"/rsh/step/#rsh_paySpec\" title=\"rsh: paySpec\"><span style=\"color: var(--shiki-color-text)\">paySpec</span></a></span> syntax. Here we accept <code>[1, tok]</code> from the caller.<a href=\"#p_68\" class=\"pid\">68</a></li>\n  <li><i id=\"p_69\" class=\"pid\"></i>Line 49 retrieves the users value from the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a></span>. If it is not there, we default to 0. Read more about why we do this in our <a href=\"/tut/erc20/#erc20\">ERC20 tutorial</a>.<a href=\"#p_69\" class=\"pid\">69</a></li>\n  <li><i id=\"p_70\" class=\"pid\"></i>Line 50 transfers the users purchase amount from the contract account in network tokens to the caller.<a href=\"#p_70\" class=\"pid\">70</a></li>\n  <li><i id=\"p_71\" class=\"pid\"></i>Line 51 returns the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a></span> value to the caller.<a href=\"#p_71\" class=\"pid\">71</a></li>\n  <li><i id=\"p_72\" class=\"pid\"></i>Line 52 deletes this user from the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_Map\" title=\"rsh: Map\"><span style=\"color: var(--shiki-token-constant)\">Map</span></a></span>, so they cannot call <code>refund</code> again.<a href=\"#p_72\" class=\"pid\">72</a></li>\n  <li><i id=\"p_73\" class=\"pid\"></i>Line 53 updates the <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> LHS values.<a href=\"#p_73\" class=\"pid\">73</a></li>\n</ul>\n<p><i id=\"p_74\" class=\"pid\"></i>Really the heart of our entire DApp is in these two functions.<a href=\"#p_74\" class=\"pid\">74</a></p>\n<p><i id=\"p_75\" class=\"pid\"></i>In 22 lines of Reach code, we can process varying purchase amounts in network tokens, reward users with Loyalty Tokens, and even process refunds!<a href=\"#p_75\" class=\"pid\">75</a></p>\n<p><i id=\"p_76\" class=\"pid\"></i>The next step in our General Flow is to assume that we close these functions because we are sold out of Loyalty Tokens. We will write this functionality into our frontend test suite later.<a href=\"#p_76\" class=\"pid\">76</a></p>\n<p><i id=\"p_77\" class=\"pid\"></i>For now, let's finish up our Reach <code>rsh</code> code. All that is left is to <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-color-text)\">transfer</span></a></span> the network token balance to the <code>Admin</code> and <span class=\"snip\"><a href=\"/rsh/step/#rsh_exit\" title=\"rsh: exit\"><span style=\"color: var(--shiki-color-text)\">exit</span></a></span> the DApp.<a href=\"#p_77\" class=\"pid\">77</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.rsh\">/examples/point-of-sale/index.rsh</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"  transfer(total).to(A);\n  commit();\n  exit();\n});\" href=\"#\" id=\"copyBtn9\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"56\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">(total)</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">A</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"57\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/consensus/#rsh_commit\" title=\"rsh: commit\"><span style=\"color: var(--shiki-token-function)\">commit</span></a><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"58\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/step/#rsh_exit\" title=\"rsh: exit\"><span style=\"color: var(--shiki-token-function)\">exit</span></a><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"59\"><span style=\"color: var(--shiki-color-text)\">});</span></li></ol></pre>\n<p><i id=\"p_78\" class=\"pid\"></i>That is all for our <code>rsh</code> file.<a href=\"#p_78\" class=\"pid\">78</a></p>\n<p><i id=\"p_79\" class=\"pid\"></i>We can finish with some simple tests for our <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> functions in the frontend <code>mjs</code> file.<a href=\"#p_79\" class=\"pid\">79</a></p>\n<p><i id=\"p_80\" class=\"pid\"></i>First, a helper function to generate a random purchase price.<a href=\"#p_80\" class=\"pid\">80</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.mjs\">/examples/point-of-sale/index.mjs</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"const getPurchasePrice = (i) => {\n  const price = Math.floor(Math.random() * 100) + MIN_PRICE;\n  return (i == 0 ? 0 : price)\n};\" href=\"#\" id=\"copyBtn10\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"17\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">getPurchasePrice</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> (i) </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"18\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">price</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">Math</span><span style=\"color: var(--shiki-token-function)\">.floor</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">Math</span><span style=\"color: var(--shiki-token-function)\">.random</span><span style=\"color: var(--shiki-color-text)\">() </span><span style=\"color: var(--shiki-token-keyword)\">*</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">100</span><span style=\"color: var(--shiki-color-text)\">) </span><span style=\"color: var(--shiki-token-keyword)\">+</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">MIN_PRICE</span><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-keyword)\">return</span><span style=\"color: var(--shiki-color-text)\"> (i </span><span style=\"color: var(--shiki-token-keyword)\">==</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">?</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> price)</span></li><li value=\"20\"><span style=\"color: var(--shiki-color-text)\">};</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_81\" class=\"pid\"></i>Line 19 checks if it is the first user, for whom we set a zero test for the <code>purchasePrice</code>.<a href=\"#p_81\" class=\"pid\">81</a></li>\n</ul>\n<p><i id=\"p_82\" class=\"pid\"></i>We have used the following testing format for <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> users in other tutorials, so we are going to tackle all of this at once.<a href=\"#p_82\" class=\"pid\">82</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/examples/point-of-sale/index.mjs\">/examples/point-of-sale/index.mjs</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"const startBuyers = async () => {\n  const runBuyer = async (i) => {\n    const acc = await stdlib.newTestAccount(stdlib.parseCurrency(100));\n    const ctc = acc.contract(backend, ctcA.getInfo());\n    const cost = getPurchasePrice(i);\n    await acc.tokenAccept(loyalTok.id);\n    try{\n      const txns = await ctc.apis.Buyer.purchase(cost);\n      console.log(`Purchase number: ${txns}`);\n    } catch (e) {\n      console.log(`${e}`);\n    }\n    if(i == 1){// 1 wants a refund\n      const amt = await ctc.apis.Buyer.refund();\n      console.log(`Customer ${i} is getting a refund of ${amt}`);\n    }\n  }// end of runBuyer\n  // 1 refund, 1 amount too low fail\n  for(let i = 0; i < USERS + FAILS; i++){\n    await runBuyer(i);\n  }\n}// end of startBuyers\" href=\"#\" id=\"copyBtn11\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"22\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">startBuyers</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function\" title=\"js: async\"><span style=\"color: var(--shiki-token-keyword)\">async</span></a><span style=\"color: var(--shiki-color-text)\"> () </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">runBuyer</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function\" title=\"js: async\"><span style=\"color: var(--shiki-token-keyword)\">async</span></a><span style=\"color: var(--shiki-color-text)\"> (i) </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_acc\" title=\"js: acc\"><span style=\"color: var(--shiki-token-constant)\">acc</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><a href=\"/frontend/#js_stdlib.newTestAccount\" title=\"js: stdlib.newTestAccount\"><span style=\"color: var(--shiki-token-function)\">.newTestAccount</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><a href=\"/frontend/#js_parseCurrency\" title=\"js: parseCurrency\"><span style=\"color: var(--shiki-token-function)\">.parseCurrency</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">100</span><span style=\"color: var(--shiki-color-text)\">));</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_ctc\" title=\"js: ctc\"><span style=\"color: var(--shiki-token-constant)\">ctc</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_acc\" title=\"js: acc\"><span style=\"color: var(--shiki-token-constant)\">acc</span></a><a href=\"/frontend/#js_contract\" title=\"js: contract\"><span style=\"color: var(--shiki-token-function)\">.contract</span></a><span style=\"color: var(--shiki-color-text)\">(backend</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">ctcA</span><a href=\"/frontend/#js_getInfo\" title=\"js: getInfo\"><span style=\"color: var(--shiki-token-function)\">.getInfo</span></a><span style=\"color: var(--shiki-color-text)\">());</span></li><li value=\"26\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">cost</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">getPurchasePrice</span><span style=\"color: var(--shiki-color-text)\">(i);</span></li><li value=\"27\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_acc\" title=\"js: acc\"><span style=\"color: var(--shiki-token-constant)\">acc</span></a><a href=\"/frontend/#js_tokenAccept\" title=\"js: tokenAccept\"><span style=\"color: var(--shiki-token-function)\">.tokenAccept</span></a><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">loyalTok</span><span style=\"color: var(--shiki-color-text)\">.id);</span></li><li value=\"28\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-keyword)\">try</span><span style=\"color: var(--shiki-color-text)\">{</span></li><li value=\"29\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">txns</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_ctc\" title=\"js: ctc\"><span style=\"color: var(--shiki-token-constant)\">ctc</span></a><span style=\"color: var(--shiki-token-function)\">.</span><a href=\"/frontend/#js_ctc.apis\" title=\"js: ctc.apis\"><span style=\"color: var(--shiki-token-constant)\">apis</span></a><span style=\"color: var(--shiki-token-function)\">.</span><span style=\"color: var(--shiki-token-constant)\">Buyer</span><span style=\"color: var(--shiki-token-function)\">.purchase</span><span style=\"color: var(--shiki-color-text)\">(cost);</span></li><li value=\"30\"><span style=\"color: var(--shiki-color-text)\">      </span><span style=\"color: var(--shiki-token-constant)\">console</span><span style=\"color: var(--shiki-token-function)\">.log</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">`Purchase number: </span><span style=\"color: var(--shiki-token-keyword)\">${</span><span style=\"color: var(--shiki-color-text)\">txns</span><span style=\"color: var(--shiki-token-keyword)\">}</span><span style=\"color: var(--shiki-token-string-expression)\">`</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"31\"><span style=\"color: var(--shiki-color-text)\">    } </span><span style=\"color: var(--shiki-token-keyword)\">catch</span><span style=\"color: var(--shiki-color-text)\"> (e) {</span></li><li value=\"32\"><span style=\"color: var(--shiki-color-text)\">      </span><span style=\"color: var(--shiki-token-constant)\">console</span><span style=\"color: var(--shiki-token-function)\">.log</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">`</span><span style=\"color: var(--shiki-token-keyword)\">${</span><a href=\"/frontend/#js_ctc.e\" title=\"js: ctc.e\"><span style=\"color: var(--shiki-color-text)\">e</span></a><span style=\"color: var(--shiki-token-keyword)\">}</span><span style=\"color: var(--shiki-token-string-expression)\">`</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"33\"><span style=\"color: var(--shiki-color-text)\">    }</span></li><li value=\"34\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-keyword)\">if</span><span style=\"color: var(--shiki-color-text)\">(i </span><span style=\"color: var(--shiki-token-keyword)\">==</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-color-text)\">){</span><span style=\"color: var(--shiki-token-comment)\">// 1 wants a refund</span></li><li value=\"35\"><span style=\"color: var(--shiki-color-text)\">      </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">amt</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_ctc\" title=\"js: ctc\"><span style=\"color: var(--shiki-token-constant)\">ctc</span></a><span style=\"color: var(--shiki-token-function)\">.</span><a href=\"/frontend/#js_ctc.apis\" title=\"js: ctc.apis\"><span style=\"color: var(--shiki-token-constant)\">apis</span></a><span style=\"color: var(--shiki-token-function)\">.</span><span style=\"color: var(--shiki-token-constant)\">Buyer</span><span style=\"color: var(--shiki-token-function)\">.refund</span><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"36\"><span style=\"color: var(--shiki-color-text)\">      </span><span style=\"color: var(--shiki-token-constant)\">console</span><span style=\"color: var(--shiki-token-function)\">.log</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-string-expression)\">`Customer </span><span style=\"color: var(--shiki-token-keyword)\">${</span><span style=\"color: var(--shiki-color-text)\">i</span><span style=\"color: var(--shiki-token-keyword)\">}</span><span style=\"color: var(--shiki-token-string-expression)\"> is getting a refund of </span><span style=\"color: var(--shiki-token-keyword)\">${</span><span style=\"color: var(--shiki-color-text)\">amt</span><span style=\"color: var(--shiki-token-keyword)\">}</span><span style=\"color: var(--shiki-token-string-expression)\">`</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"37\"><span style=\"color: var(--shiki-color-text)\">    }</span></li><li value=\"38\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-comment)\">// end of runBuyer</span></li><li value=\"39\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-comment)\">// 1 refund, 1 amount too low fail</span></li><li value=\"40\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-function)\">for</span><span style=\"color: var(--shiki-color-text)\">(let i </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-color-text)\">; i </span><span style=\"color: var(--shiki-token-keyword)\">&lt;</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">USERS</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">+</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">FAILS</span><span style=\"color: var(--shiki-color-text)\">; i</span><span style=\"color: var(--shiki-token-keyword)\">++</span><span style=\"color: var(--shiki-color-text)\">){</span></li><li value=\"41\"><span style=\"color: var(--shiki-color-text)\">    await </span><span style=\"color: var(--shiki-token-function)\">runBuyer</span><span style=\"color: var(--shiki-color-text)\">(i);</span></li><li value=\"42\"><span style=\"color: var(--shiki-color-text)\">  }</span></li><li value=\"43\"><span style=\"color: var(--shiki-color-text)\">}</span><span style=\"color: var(--shiki-token-comment)\">// end of startBuyers</span></li></ol></pre>\n<ul>\n  <li><i id=\"p_83\" class=\"pid\"></i>Line 22 is the outer function we'll call from <code>launched</code>.<a href=\"#p_83\" class=\"pid\">83</a></li>\n  <li><i id=\"p_84\" class=\"pid\"></i>Line 23 starts the inner function to run individual user actions.<a href=\"#p_84\" class=\"pid\">84</a></li>\n  <li><i id=\"p_85\" class=\"pid\"></i>Line 24-25 are for necessary account and contract tasks.<a href=\"#p_85\" class=\"pid\">85</a></li>\n  <li><i id=\"p_86\" class=\"pid\"></i>Line 26 gets a random purchase price from our <code>getPurchasePrice()</code> function.<a href=\"#p_86\" class=\"pid\">86</a></li>\n  <li><i id=\"p_87\" class=\"pid\"></i>Line 27 opts the user in to the Loyalty Token. This is only necessary on AVM networks.<a href=\"#p_87\" class=\"pid\">87</a></li>\n  <li><i id=\"p_88\" class=\"pid\"></i>Line 28 starts a <code>try...catch</code> -- we expect our zero cost purchase call to fail.<a href=\"#p_88\" class=\"pid\">88</a></li>\n  <li><i id=\"p_89\" class=\"pid\"></i>Line 29 makes the <span class=\"snip\"><a href=\"/rsh/appinit/#rsh_API\" title=\"rsh: API\"><span style=\"color: var(--shiki-token-constant)\">API</span></a></span> call to the contract.<a href=\"#p_89\" class=\"pid\">89</a></li>\n  <li><i id=\"p_90\" class=\"pid\"></i>Line 31-33 handles and logs the exception.<a href=\"#p_90\" class=\"pid\">90</a></li>\n  <li><i id=\"p_91\" class=\"pid\"></i>Line 34-37 simulates the first user requesting a refund.<a href=\"#p_91\" class=\"pid\">91</a></li>\n  <li><i id=\"p_92\" class=\"pid\"></i>Lines 40-42 sets up a looping construct to create and run users.<a href=\"#p_92\" class=\"pid\">92</a></li>\n</ul>\n<p><i id=\"p_93\" class=\"pid\"></i>IF we made no mistakes, that is it. Our point-of-sale DApp is ready!<a href=\"#p_93\" class=\"pid\">93</a></p>\n<p><i id=\"p_94\" class=\"pid\"></i>This DApp has no restrictions and will run on different consensus networks.<a href=\"#p_94\" class=\"pid\">94</a></p>\n<pre class=\"snippet unnumbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\"./reach run\" href=\"#\" id=\"copyBtn12\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-keyword)\">$</span><span style=\"color: var(--shiki-color-text)\"> ./reach run</span></li></ol></pre>\n<p><i id=\"p_95\" class=\"pid\"></i>You should see output that looks like this:<a href=\"#p_95\" class=\"pid\">95</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\"Welcome to the point-of-sale machine. This machine processes\npayments of varying amounts and rewards each purchase with a loyalty token.\nThe pos will also process refunds, which return network tokens to the customer,\nand loyalty tokens to the contract.\n\nReady at contract: 0xf7cC1177E46EFC30E6C018c4f5a04bc6A6E860df\n\nError: Buyer.purchase errored with Error: Assertion failed: Buyer_purchase: sorry, amount too low\n  at reach standard library:57:5:application\n  at ./index.rsh:37:12:application call to &quot;check&quot; (defined at: reach standard library:49:32:function exp)\n  at ./index.rsh:34:39:application call to [unknown function] (defined at: ./index.rsh:34:39:function exp)\n  at ./index.rsh:28:45:application call to &quot;runBuyer_purchase0_81&quot; (defined at: ./index.rsh:34:10:function exp)\n  at ./index.rsh:28:45:application call to [unknown function] (defined at: ./index.rsh:28:45:function exp)\nPurchase number: 1\nCustomer 1 is getting a refund of 81\nPurchase number: 1\nPurchase number: 2\nPurchase number: 3\nPurchase number: 4\nPurchase number: 5\nPurchase number: 6\nPurchase number: 7\nPurchase number: 8\nPurchase number: 9\nPurchase number: 10\nExiting...\" href=\"#\" id=\"copyBtn13\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\">Welcome to the point-of-sale machine. This machine processes</li><li value=\"2\">payments of varying amounts and rewards each purchase with a loyalty token.</li><li value=\"3\">The pos will also process refunds, which return network tokens to the customer,</li><li value=\"4\">and loyalty tokens to the contract.</li><li value=\"5\"></li><li value=\"6\">Ready at contract: 0xf7cC1177E46EFC30E6C018c4f5a04bc6A6E860df</li><li value=\"7\"></li><li value=\"8\">Error: Buyer.purchase errored with Error: Assertion failed: Buyer_purchase: sorry, amount too low</li><li value=\"9\">  at reach standard library:57:5:application</li><li value=\"10\">  at ./index.rsh:37:12:application call to \"check\" (defined at: reach standard library:49:32:function exp)</li><li value=\"11\">  at ./index.rsh:34:39:application call to [unknown function] (defined at: ./index.rsh:34:39:function exp)</li><li value=\"12\">  at ./index.rsh:28:45:application call to \"runBuyer_purchase0_81\" (defined at: ./index.rsh:34:10:function exp)</li><li value=\"13\">  at ./index.rsh:28:45:application call to [unknown function] (defined at: ./index.rsh:28:45:function exp)</li><li value=\"14\">Purchase number: 1</li><li value=\"15\">Customer 1 is getting a refund of 81</li><li value=\"16\">Purchase number: 1</li><li value=\"17\">Purchase number: 2</li><li value=\"18\">Purchase number: 3</li><li value=\"19\">Purchase number: 4</li><li value=\"20\">Purchase number: 5</li><li value=\"21\">Purchase number: 6</li><li value=\"22\">Purchase number: 7</li><li value=\"23\">Purchase number: 8</li><li value=\"24\">Purchase number: 9</li><li value=\"25\">Purchase number: 10</li><li value=\"26\">Exiting...</li></ol></pre>\n<p><i id=\"p_96\" class=\"pid\"></i>Done!<a href=\"#p_96\" class=\"pid\">96</a></p>\n<p><i id=\"p_97\" class=\"pid\"></i>If you have completed all of the tutorials up until this point, you are getting pretty good at this. If not, don't worry - practice makes perfect. Plus, we at Reach are never gonna <a href=\"https://youtu.be/dQw4w9WgXcQ\" target=\"_blank\">give you up</a>.<a href=\"#p_97\" class=\"pid\">97</a></p>\n<h2 id=\"bonus-exercise\" class=\"refHeader\">Bonus Exercise<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#bonus-exercise\"><span class=\"icon icon-link\"></span></a></h2>\n<p><i id=\"p_98\" class=\"pid\"></i>To understand the Verification Checks and Invariants of this program better, let's break it.<a href=\"#p_98\" class=\"pid\">98</a></p>\n<p><i id=\"p_99\" class=\"pid\"></i>Now that the program is running to completion, go back to your <code>rsh</code> file and start commenting out the <span class=\"snip\"><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-color-text)\">check</span></a></span>s and <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_invariant\" title=\"rsh: invariant\"><span style=\"color: var(--shiki-color-text)\">invariant</span></a></span>s. Nearly every one of them is necessary for this DApp to compile and run.<a href=\"#p_99\" class=\"pid\">99</a></p>\n<p><i id=\"p_100\" class=\"pid\"></i>Study the compilation errors, understand where they are pointing and why. This is the primary reason we like to include the optional error messages in our <span class=\"snip\"><a href=\"/rsh/compute/#rsh_check\" title=\"rsh: check\"><span style=\"color: var(--shiki-color-text)\">check</span></a></span>s!<a href=\"#p_100\" class=\"pid\">100</a></p>\n<p><i id=\"p_101\" class=\"pid\"></i>Reach out to us in the <a href=\"https://discord.gg/kbfNkdaMhD\" target=\"_blank\">Discord</a> <code>#tutorial</code> channel to tell us you got Rickrolled or brag about your new skills. Just a little though.<a href=\"#p_101\" class=\"pid\">101</a></p>\n<p><i id=\"p_102\" class=\"pid\"></i>Maybe then tell us about your dreams and aspirations -- or maybe just where you are from.<a href=\"#p_102\" class=\"pid\">102</a></p>\n<p><i id=\"p_103\" class=\"pid\"></i>Your call.<a href=\"#p_103\" class=\"pid\">103</a></p>","<ul><li class=\"dynamic\">\n    <a href=\"#point-of-sale\">Point of Sale</a>\n    <ul class=\"dynamic\">\n      <li class=\"dynamic\">\n        <a href=\"#program-design\">Program Design</a>\n        <ul class=\"dynamic\">\n          <li class=\"dynamic\"><a href=\"#here-is-the-general-flow-of-our-dapp\">Here is the general flow of our DApp:</a></li>\n        </ul>\n      </li>\n      <li class=\"dynamic\">\n        <a href=\"#where-the-users-at\">Where the users at?</a>\n      </li>\n      <li class=\"dynamic\">\n        <a href=\"#bonus-exercise\">Bonus Exercise</a>\n      </li>\n    </ul>\n  </li></ul>"]