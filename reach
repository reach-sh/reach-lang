#!/bin/sh

IMG='reachsh/reach-cli:latest'
TMP=$(mktemp -d -p /tmp "reach.$(date -u '+%Y-%m-%dT%H-%M-%SZ')-XXXX")
export TMP

run_d () {
  if [ "$CIRCLECI" = "true" ]; then
    REACH_EX="$0" ~/.local/bin/reach \
      --dir-embed="$(cd "$(dirname "$0")" && pwd)/hs/app/reach/embed" \
      --dir-project-container="$(pwd)" \
      --dir-project-host="$(pwd)" \
      --dir-tmp-container="$TMP" \
      --dir-tmp-host="$TMP" \
      "$@"
  else
    docker run -t --rm \
      -e "REACH_EX=$0" \
      -e "REACH_CONNECTOR_MODE" \
      -e "REACH_DEBUG" \
      -e "REACH_RPC_KEY" \
      -e "REACH_RPC_PORT"  \
      -e "REACH_RPC_SERVER" \
      -e "REACH_RPC_TLS_CRT" \
      -e "REACH_RPC_TLS_KEY" \
      -e "REACH_RPC_TLS_PASSPHRASE" \
      -e "REACH_RPC_TLS_REJECT_UNVERIFIED" \
      -e "REACH_VERSION" \
      -u "$(id -ru):$(id -rg)" \
      -v "$TMP:/app/tmp" \
      -v "$(pwd):/app/src" \
      "$IMG" --dir-project-host="$(pwd)" --dir-tmp-host="$TMP" "$@"
  fi
}

run_s () {
  chmod 700 "$TMP/out.sh"
  sh -ac "$TMP/out.sh" "$0"
}

for DEP in make curl docker docker-compose; do
  if ! (which "${DEP}" >/dev/null 2>&1); then
    echo "Reach relies on an installation of ${DEP}"
    exit 1
  fi
done

if [ ! "$CIRCLECI" = "true" ] && [ "$(docker image ls -q $IMG)" = '' ]; then
  if ! (docker pull "$IMG" && run_d update && run_s); then exit 1; fi
fi

run_d "$@"
case "$?" in
  42) run_s ;;
  50) curl https://docs.reach.sh/reach -o "$0" && chmod +x "$0" && exit 0 ;;
   1) exit 1 ;;
esac
