<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>5&nbsp;Timeouts and Participation</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Pay-<wbr></wbr>To-<wbr></wbr>Play Tic-<wbr></wbr>Tac-<wbr></wbr>Toe Tutorial</a></td></tr></table></div><div class="tocviewsublistonly" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="tic-tac-0.html" class="tocviewlink" data-pltdoc="x">Install and Initialize</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tic-tac-1.html" class="tocviewlink" data-pltdoc="x">Scaffolding and Setup</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="tic-tac-2.html" class="tocviewlink" data-pltdoc="x">Tic-<wbr></wbr>Tac-<wbr></wbr>Toe</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="tic-tac-3.html" class="tocviewlink" data-pltdoc="x">Pay-<wbr></wbr>to-<wbr></wbr>Play</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Timeouts and Participation</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="tic-tac-6.html" class="tocviewlink" data-pltdoc="x">Interaction and Independence</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="tic-tac-7.html" class="tocviewlink" data-pltdoc="x">Web Interaction</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="algo.html" class="tocviewlink" data-pltdoc="x">Running on Algorand</a></td></tr><tr><td align="right">9&nbsp;</td><td><a href="trouble.html" class="tocviewlink" data-pltdoc="x">Troubleshooting</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tic-tac-3.html" title="backward to &quot;4 Pay-to-Play&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Pay-To-Play Tic-Tac-Toe Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tic-tac-6.html" title="forward to &quot;6 Interaction and Independence&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3>5<tt>&nbsp;</tt><a name="(part._tic-tac-5)"></a>Timeouts and Participation</h3><p>In this section, we&rsquo;ll focus on a subtle issue that is important and unique to decentralized applications: <font class="badlink">non-participation</font>.</p><p>Non-participation refers to the act of one party ceasing to continue playing their role in an application.</p><p>In traditional client-server programs, like a Web server, this would be the case of a client not sending any more requests to the server, or the server stopping sending responses to the client.
In these sorts of traditional programs, non-participation is an exceptional circumstance that normally leads to an error message for clients and, at most, a log entry for servers.
Sometimes traditional programs will need to recycle resources, like network ports, on non-participation, but they would have also needed to do that if the transaction ended by normal means.
In other words, for traditional client-server programs, it is not necessary for designers to meticulously consider the consequences of non-participation.</p><p>In contrast, decentralized applications must be carefully designed with an eye towards their behavior in the face of non-participation.
For example, consider what happens in our Tic-Tac-Toe game if after Alice has paid her wager, Bob never accepts and the application doesn&rsquo;t continue.
In this case, Alice&rsquo;s <font class="badlink"><span class="techoutside"><span class="techinside">network tokens</span></span></font> would be locked inside of the <font class="badlink"><span class="techoutside"><span class="techinside">contract</span></span></font> and lost to her.
Similarly, if after Bob accepted and paid his wager, Alice stopped participating and never submitted her hand, then both their funds would be locked away forever.
In each of these cases, both parties would be greatly hurt and their fear of that outcome would introduce an additional cost to transacting, which would lower the value they got from participating in the application.
Of course, in a situation like Tic-Tac-Toe this is unlikely to be an important matter, but recall that Tic-Tac-Toe is a microcosm of decentralized application design.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Technically, in the first case, when Bob fails to start the application, Alice is not locked away from her funds: since Bob&rsquo;s identity is not fixed until after his first message, she could start another instance of the game as the Bob role and then she&rsquo;d win all of the funds, less any transaction costs of the <font class="badlink"><span class="techoutside"><span class="techinside">consensus network</span></span></font>.
In the second case, however, there would be no recourse for either party.</p></blockquote></blockquote></blockquote><p>In the rest of this section, we&rsquo;ll discuss how Reach helps address non-participation.
For a longer discussion, refer to <font class="badlink">the guide chapter on non-participation</font>.</p><p>In Reach, non-participation is handled through a "timeout" mechanism whereby each <font class="badlink"><span class="techoutside"><span class="techinside">consensus transfer</span></span></font> can be paired with a <font class="badlink"><span class="techoutside"><span class="techinside">step</span></span></font> that occurs for all <font class="badlink"><span class="techoutside"><span class="techinside">participants</span></span></font> if the <font class="badlink"><span class="techoutside"><span class="techinside">originator</span></span></font> of the <font class="badlink"><span class="techoutside"><span class="techinside">consensus transfer</span></span></font> fails to make the required <font class="badlink"><span class="techoutside"><span class="techinside">publication</span></span></font> before a particular <font class="badlink"><span class="techoutside"><span class="techinside">time</span></span></font>.
We&rsquo;ll integrate this mechanism into our version of Tic-Tac-Toe.</p><p>First, we&rsquo;ll modify the <font class="badlink"><span class="techoutside"><span class="techinside">participant interact interface</span></span></font> to allow the <font class="badlink"><span class="techoutside"><span class="techinside">frontend</span></span></font> to be informed that a timeout occurred.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tic-tac-4/index.rsh#L80-L80"><span class="stt">tic-tac-4/index.rsh</span></a><button class="btn" data-clipboard-text="        informTimeout: Fun([], Null) };"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">80</span>      <font class="badlink"><span class="nx">informTimeout</span></font><font class="badlink"><span class="o">:</span></font> <font class="badlink"><span class="nx">Fun</span></font><span class="p">([],</span> <font class="badlink"><span class="nx">Null</span></font><span class="p">)</span> <span class="p">};</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 80 introduces a new method, informTimeout, that receives no arguments and returns no information.
We&rsquo;ll call this function when a timeout occurs.</p></li></ul><p>We&rsquo;ll make a slight tweak to our JavaScript <font class="badlink"><span class="techoutside"><span class="techinside">frontend</span></span></font> to be able to receive this message and display it on the console.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tic-tac-4/index.mjs#L69-L72"><span class="stt">tic-tac-4/index.mjs</span></a><button class="btn" data-clipboard-text="    informTimeout : () =&gt; {
        console.log(`There was a timeout.`);
        process.exit(1);
    },"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">69</span>        <font class="badlink"><span class="nx">informTimeout</span></font> <font class="badlink"><span class="o">:</span></font> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">70</span>      <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`There was a timeout.`</span><span class="p">);</span>
<span class="mi">71</span>      <font class="badlink"><span class="nx">process</span></font><span class="p">.</span><font class="badlink"><span class="nx">exit</span></font><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="mi">72</span>        <span class="p">},</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>Back in the Reach program, we&rsquo;ll define an identifier at the top of our program to use a standard deadline throughout the program.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tic-tac-4/index.rsh#L88-L88"><span class="stt">tic-tac-4/index.rsh</span></a><button class="btn" data-clipboard-text="const DEADLINE = 240;"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">88</span>    <font class="badlink"><span class="kr">const</span></font> <font class="badlink"><span class="nx">DEADLINE</span></font> <font class="badlink"><span class="o">=</span></font> <span class="mi">240</span><span class="p">;</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 88 defines the deadline as 240 <font class="badlink"><span class="techoutside"><span class="techinside">time delta</span></span></font> units, which are an abstraction of the underlying notion of <font class="badlink"><span class="techoutside"><span class="techinside">time</span></span></font> in the <font class="badlink"><span class="techoutside"><span class="techinside">consensus network</span></span></font>.
In many networks, like Ethereum, this number is a number of blocks.</p></li></ul><p>Next, at the start of the Reach application, we&rsquo;ll define a helper function to inform each of the participants of the timeout by calling this new method.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tic-tac-4/index.rsh#L95-L99"><span class="stt">tic-tac-4/index.rsh</span></a><button class="btn" data-clipboard-text="        const informTimeout = () =&gt; {
            each([A, B], () =&gt; {
                interact.informTimeout();
            });
        };"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">95</span>      <font class="badlink"><span class="kr">const</span></font> <font class="badlink"><span class="nx">informTimeout</span></font> <font class="badlink"><span class="o">=</span></font> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">96</span>          <font class="badlink"><span class="nx">each</span></font><span class="p">([</span><font class="badlink"><span class="nx">A</span></font><span class="p">,</span> <font class="badlink"><span class="nx">B</span></font><span class="p">],</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">97</span>              <font class="badlink"><span class="nx">interact</span></font><span class="p">.</span><font class="badlink"><span class="nx">informTimeout</span></font><span class="p">();</span>
<span class="mi">98</span>          <span class="p">});</span>
<span class="mi">99</span>      <span class="p">};</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 95 defines the function as an <font class="badlink"><span class="techoutside"><span class="techinside">arrow expression</span></span></font>.</p></li><li><p>Line 96 has each of the participants perform a <font class="badlink"><span class="techoutside"><span class="techinside">local step</span></span></font>.</p></li><li><p>Line 97 has them call the new informTimeout method.</p></li></ul><p>We won&rsquo;t change Alice&rsquo;s first message, because there is no consequence to her as a non-participant: if she doesn&rsquo;t start the game, then no one is any worse off.</p><p>However, we will adjust Bob&rsquo;s first message, because if he fails to participate, then Alice&rsquo;s initial wager will be lost to her.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tic-tac-4/index.rsh#L112-L112"><span class="stt">tic-tac-4/index.rsh</span></a><button class="btn" data-clipboard-text="        .pay(wagerAmount).timeout(DEADLINE, () =&gt; closeTo(A, informTimeout));"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">112</span>      <span class="p">.</span><font class="badlink"><span class="nx">pay</span></font><span class="p">(</span><font class="badlink"><span class="nx">wagerAmount</span></font><span class="p">).</span><font class="badlink"><span class="nx">timeout</span></font><span class="p">(</span><font class="badlink"><span class="nx">DEADLINE</span></font><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <font class="badlink"><span class="nx">closeTo</span></font><span class="p">(</span><font class="badlink"><span class="nx">A</span></font><span class="p">,</span> <font class="badlink"><span class="nx">informTimeout</span></font><span class="p">));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 112 adds a timeout handler to Bob&rsquo;s <font class="badlink"><span class="techoutside"><span class="techinside">publication</span></span></font>.</p></li></ul><p>The timeout handler specifies that if Bob does not complete this action within a <font class="badlink"><span class="techoutside"><span class="techinside">time delta</span></span></font> of DEADLINE, then the application transitions to <font class="badlink"><span class="techoutside"><span class="techinside">step</span></span></font> given by the arrow expression.
In this case, the timeout code is a call to closeTo, which is a Reach standard library function that has Alice send a message and transfer all of the funds in the <font class="badlink"><span class="techoutside"><span class="techinside">contract</span></span></font> to herself, then call the given function afterwards.
This means that if Bob fails to publish his hand, then Alice will take her <font class="badlink"><span class="techoutside"><span class="techinside">network tokens</span></span></font> back.</p><p>We will add a similar timeout handler to Alice&rsquo;s second message.</p><p>But in this case, Bob will be able to claim all of the funds if Alice doesn&rsquo;t participate.
You might think that it would be "fair" for Alice&rsquo;s funds to be returned to Alice and Bob&rsquo;s to Bob.
However, if we implemented it that way, then Alice would be wise to always timeout if she were going to lose, which she knows will happen, because she knows her hand and Bob&rsquo;s hand.</p><p>These are the only changes we need to make to the Reach program to make it robust against non-participation: seven lines!</p><p>If you where to run the program and see what happens, there would be no noticeable difference from the last chapter, but when we implement the next part, <a href="tic-tac-6.html" data-pltdoc="x">Interaction and Independence</a>, you would be able to timeout the game.</p><p><a href="index.html" data-pltdoc="x">Main menu</a></p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tic-tac-3.html" title="backward to &quot;4 Pay-to-Play&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Pay-To-Play Tic-Tac-Toe Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tic-tac-6.html" title="forward to &quot;6 Interaction and Independence&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>